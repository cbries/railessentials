function getRouteByName(n){if(typeof n=="undefined"||n==null||n.length===0||typeof routes=="undefined"||window.routes==null)return null;for(let t=0;t<window.routes.length;++t){const i=window.routes[t];if(i.name===n)return i}return null}function getWidthOfText(n,t,i){getWidthOfText.c===undefined&&(getWidthOfText.c=document.createElement("canvas"),getWidthOfText.ctx=getWidthOfText.c.getContext("2d"));var r=i+" "+t;return getWidthOfText.ctx.font!==r&&(getWidthOfText.ctx.font=r),getWidthOfText.ctx.measureText(n).width}function addJqueryExtensions(){$.fn.filterByData=function(n,t){return this.filter(function(){return $(this).data(n)==t})}}function hexToRgbA(n){n.charAt(0)!=="#"&&(n="#"+n);var t;if(/^#([A-Fa-f0-9]{3}){1,2}$/.test(n))return t=n.substring(1).split(""),t.length===3&&(t=[t[0],t[0],t[1],t[1],t[2],t[2]]),t="0x"+t.join(""),{r:t>>16&255,g:t>>8&255,b:t&255,w:1023};throw new Error("Bad Hex");}function toggleAllLocomotiveInformation(n){const i=$("div.locomotiveInfo");let t;const r=i.length;for(t=0;t<r;++t)n===!0?$(i[t]).show():$(i[t]).hide()}function toggleAllLabelInformation(n){const i=$("div.elementLabel");let t;const r=i.length;for(t=0;t<r;++t)n===!0?$(i[t]).show():$(i[t]).hide()}function toggleAllWebcamsVisibility(n){const i=$("div.videoStream");let t;const r=i.length;for(t=0;t<r;++t)n===!0?$(i[t]).show():$(i[t]).hide()}function getAccByEcosAddr(n,t){if(typeof n=="undefined"||n==null||typeof t=="undefined"||t==null)return null;const i=n.length;for(let r=0;r<i;++r){const f=$(n[r]),u=f.data(constDataThemeItemObject);if(u!=null){const i=u.addresses;if(typeof i!="undefined"&&i!=null){const e=(i.Addr1-1)*4+i.Port1,o=(i.Addr2-1)*4+i.Port2;if(t===e||t===o){const n=parseInt(i.Addr1)>0&&parseInt(i.Port1)>0,t=parseInt(i.Addr2)>0&&parseInt(i.Port2)>0;return{planItem:f,themeData:u,ecosAddresses:[{ecosAddr:e,ecosAddrValid:n,inverse:i.Inverse1},{ecosAddr:o,ecosAddrValid:t,inverse:i.Inverse2}]}}}}}return null}function getFbByEcosAddr(n,t){if(typeof n=="undefined"||n==null||typeof t=="undefined")return null;const i=n.length;for(let r=0;r<i;++r){const u=$(n[r]),i=u.data(constDataThemeItemObject);if(i!=null&&typeof i.addresses!="undefined"&&i.addresses!=null){const f=i.addresses.Addr;if(f===t)return{planItem:u,themeData:i,ecosAddr:{Addr:i.addresses.Addr}}}}return null}function getDirpathOf(n){const t=n.replace("\\","/").lastIndexOf("/");return n.substr(0,t+1)}function getLabelOffsetBy(n){const i=n.editor.themeId,t={"font-size":"8px","z-index":10,position:"relative",top:"0px",left:"0px"};switch(i){case 10:return null;case 11:return null;case 13:return null;case 14:return null;case 1013:return null;case 50:return t.top="-14px",t.left="30px",t;case 51:return t.top="-10px",t.left="-4px",t;case 58:return t.top="-14px",t.left="0",t;case 101:return t.top="-13px",t.left="2px",t;case 150:case 151:return t.top="-14px",t.left="10px",t;case 200:return t.top="-12px",t.left="6px",t}return t}function getArrayOfFunctions2(n,t,i,r){return getArrayOfFunctions({oid:n,noOfFunctions:t,funcset:i,funcdesc:r})}function getArrayOfFunctions(n){const t=[],u=n.oid,f=n.noOfFunctions,i=n.funcset,e=n.funcdesc;var r=0;for(let n=0;n<i.length;++n){const o=e[n];if(typeof o!="undefined"&&o!=null&&typeof o.idx!="undefined"&&o.idx!=null){const s=o.idx,h=o.type;if(h!==0){const c={oid:u,idx:s,state:parseInt(i[s])===1,type:h};if(t.push(c),r++,r>=f)break}}}return t}function loadLocomotiveImageIntoHtml(n,t,i="100%"){if(typeof window.__cachedLocomotiveImages[t]!="undefined"&&window.__cachedLocomotiveImages[t]!=null){const i=$("img#"+n);i.get(0).src=window.__cachedLocomotiveImages[t]}const r=new Image;(typeof i=="undefined"||i==null)&&(i="100%");r.onload=function(){const r=$("img#"+n);r.get(0).src=this.src;r.css({width:i});window.__cachedLocomotiveImages[t]=this.src};t=t.replace("/","_");t=t.replace(".","_");const u="./images/locomotives/"+t+".png";r.src=u}function getCtrlOfPosition(n,t,i){if(n==null||t==null||i==null)return null;let r;const u=i.length;for(r=0;r<u;++r){const u=i[r];if(u!=="undefined"&&u!==null){const f=u.offsetTop,e=u.offsetLeft,o=u.getBoundingClientRect(),s=o.width,h=o.height,c=e+s,l=f+h;if(n>=e&&n<=c&&t>=f&&t<=l)return $(u)}}return null}function getCtrlOfCoord(n,t,i){if(n==null||t==null||i==null)return null;let r;const u=i.length;for(r=0;r<u;++r){const f=$(i[r]);if(typeof f!="undefined"&&f!==null){const e=f.data(constDataThemeItemObject);if(typeof e!="undefined"&&e!=null){const u=e.coord;if(typeof u=="undefined"||u==null)return null;if(u.x===n&&u.y===t)return u}}}return null}function getCtrlOfEvent(n,t,i){return getCtrlOfPosition(t.pageX-n.get(0).offsetLeft,t.pageY-n.get(0).offsetTop,i)}function getElementCoord(n,t){const u=n.get(0),f=u.offsetTop,e=u.offsetLeft,o=t.pageX-e,s=t.pageY-f;var i=o/constItemWidth,r=s/constItemHeight;return i=Math.floor(i),r=Math.floor(r),i<0&&(i=0),r<0&&(r=0),{x:i,y:r}}function getElementStartCoord(n,t,i){const f=n.get(0).offsetLeft,e=n.get(0).offsetTop,o=t-f,s=i-e;var r=o/constItemWidth,u=s/constItemHeight;return r=Math.floor(r),u=Math.floor(u),r<0&&(r=0),u<0&&(u=0),{x:r,y:u}}function coord2pixel(n){if(n!=null)return{x:n.x*constItemWidth,y:n.y*constItemHeight}}function getThemeJsonData(n){return n==null?null:n.data(constDataThemeItemObject)}function getThemeJsonDataById(n){const t=$("div.ctrlItemFeedback");for(let i=0;i<t.length;++i){const r=t[i],u=$(r).attr("id");if(u===n)return getThemeJsonData($(r))}return null}function setThemeJsonDataById(n,t){const i=$("div.ctrlItemFeedback");for(let r=0;r<i.length;++r){const u=i[r],f=$(u).attr("id");if(f===n)return $(u).data(constDataThemeItemObject,t),!0}return!1}function getItemRenderedSize(n){const u={w:constItemWidth,h:constItemHeight},t=getThemeJsonData(n);if(t==null||typeof t.dimensions=="undefined")return u;var i=n.data(constDataThemeDimensionIndex);typeof i=="undefined"&&(i=0);const r=t.dimensions[i];return{w:constItemWidth*r.w,h:constItemHeight*r.h}}function isSignal(n){return n?n>=100&&n<=125?!0:!1:!1}function isSwitchOrAccessory(n){return n?n>=50&&n<150&&n!==54&&n!==55?!0:!1:!1}function isAccessory(n){return n?n>=250&&n<=260?!0:!1:!1}function isDecoupler(n){return n?n===70?!0:!1:!1}function isBlock(n){return n===150?!0:n===151?!0:n===152?!0:!1}function isFeedback(n){return n?n>=200&&n<=210?!0:!1:!1}function changeLocomotive(n,t={}){var i=window.serverHandling;typeof i!="undefined"&&i!=null&&(t.mode=n,i.sendCommand({command:"locomotive",timestamp:Date.now(),cmddata:t}))}function accessoryExecute(n){var t=window.serverHandling;typeof t!="undefined"&&t!=null&&t.sendCommand({command:"accessory",timestamp:Date.now(),cmddata:n})}function itemClicked(n){var t=window.serverHandling;typeof t!="undefined"&&t!=null&&t.sendCommand({command:"accessory",timestamp:Date.now(),cmddata:n})}function assignLocomotiveToBlock(n){var t=window.serverHandling;typeof t!="undefined"&&t!=null&&t.sendCommand({command:"routing",timestamp:Date.now(),cmddata:n})}function resetAssignment(n){var t=window.serverHandling;typeof t!="undefined"&&t!=null&&t.sendCommand({command:"routing",timestamp:Date.now(),cmddata:n})}function gotoBlock(n){var t=window.serverHandling;typeof t!="undefined"&&t!=null&&t.sendCommand({command:"routing",timestamp:Date.now(),cmddata:n})}function checkRoute(n){var t=window.serverHandling;typeof t!="undefined"&&t!=null&&t.sendCommand({command:"routing",timestamp:Date.now(),cmddata:n})}function changeSetting(n){var t=window.serverHandling;typeof t!="undefined"&&t!=null&&t.sendCommand({command:"setting",timestamp:Date.now(),cmddata:n})}function relayWebsocketCommand(n){var t=window.serverHandling;typeof t!="undefined"&&t!=null&&t.sendCommand({command:"relayCommand",timestamp:Date.now(),cmddata:n})}function removeTextfieldFromGlobalList(n){var i,t,r;if(n!=null){for(i=-1,t=0;t<window.textfieldElementInstances.length;++t)if(r=window.textfieldElementInstances[t],r.__uniqueId===n){i=t;break}i!==-1&&window.textfieldElementInstances.splice(i,1)}}function removeLocomotiveDialogFromGlobalList(n){for(var r,i=[],t=0;t<window.locomotiveCtrlDlgs.length;++t){if(r=window.locomotiveCtrlDlgs[t],r==null){i.push(t);continue}try{r.__dlgId===n&&i.push(t)}catch(f){}}const u=i.reverse();for(t=0;t<u.length;++t)window.locomotiveCtrlDlgs.splice(u[t],1)}function openLocomotiveControlDialogByOid(n){const t=window.locomotivesDlg.getLocomotiveRecord(n);openLocomotiveControlDialog(t)}function openLocomotiveControlDialog(n){const t=new LocomotiveControl,i=t.open(n);if(i){window.locomotiveCtrlDlgs.push(t);t.on("dialogClosed",function(n){removeLocomotiveDialogFromGlobalList(n.data.instance.id)});t.on("functionChanged",function(n){changeLocomotive("function",n.data)});t.on("speedChanged",function(n){changeLocomotive("speedstep",n.data)});t.on("directionChanged",function(n){changeLocomotive("direction",n.data)})}else console.log("Already open!")}function initDebugConsole(){const t=$("#statusBar div.logging"),n=$(".debugConsole");t.click(function(){if(n.is(":visible"))n.hide();else{n.css({bottom:$("#statusBar").height()+1+"px",right:$("#sidebar").width()+"px"});(typeof __ctrlDebugConsoleInitialized=="undefined"||window.__ctrlDebugConsoleInitialized==null||window.__ctrlDebugConsoleInitialized===!1)&&(window.__ctrlDebugConsoleInitialized=!0,n.resizable({handles:"n, w",stop:function(){realignDebugConsole()}}));n.show();const t=document.getElementsByClassName("debugConsole");t[0].scrollTop=t[0].scrollHeight}})}function changeWorkspace(){const n=$("#w2ui-popup table#workspaceSelection").find("select :selected").val();typeof n=="undefined"||n==null||n.length<=0||window.open("?workspace="+n,"_self")}function createWorkspace(n){for(let t=0;t<n.length;++t){const i=$(n[t]).val();if(typeof i!="undefined"&&i!=null&&i.length>0){window.open("?workspace="+i,"_self");return}}}function handleWorkspace(){const n=$("#workspaceSelectionFrame");n.w2popup({title:"Workspace Selection",height:"200px",width:"450px",buttons:'<button class="w2ui-btn" onclick="w2popup.close();">Close<\/button>',onOpen:function(n){n.onComplete=function(){}}})}function realignDebugConsole(){const n=$(".debugConsole");n.css({inset:"",bottom:$("#statusBar").height()+1+"px",right:$("#sidebar").width()+"px",position:"absolute"})}function __formatDebugMessage(n){return typeof n=="undefined"?null:n==null?null:'<span class="dt">'+n.time+'<\/span><span class="msg">'+n.message+"<\/span>"}function isBlank(n){return!n||/^\s*$/.test(n)}function addDebugMessages(n,t="messageContainer"){const r=document.getElementsByClassName(t),i=r[0];for(let t=0;t<n.length;++t){let f=i.innerHTML;const u=JSON.parse(n[t]);if(u.message.length!==0){const r=__formatDebugMessage(u);r!=null&&(i.innerHTML=i.innerHTML.length===0||isBlank(i.innerHTML)?r:f+"<br>"+r)}}i.scrollTop=i.scrollHeight}function reinitAutoMode(n){(typeof __autoModeState=="undefined"||window.__autoModeState==null)&&(window.__autoModeState=n);n===!0&&$("#statusBar div.autoMode").addClass("fa-spin")}var _htmlEntities,loadSideBar;(function(n){n.fn.speedCurve=function(t){function y(){r.append('<div class="speedCurveRoot"><\/div><div class="speedCurveControls">Preloads:<input type="button" id="cmdSpeedRestore" value="Restore"><input type="button" id="cmdSpeedLinear" value="Linear"><input type="button" id="cmdSpeedExponentialEsu" value="Exponential ESU"><input type="button" id="cmdSpeedExponentialLenz" value="Exponential Lenz"><input type="checkbox" class="chkLabelShow" name="chkLabelShow"><label for="chkLabelShow" style="padding-bottom: 1px;"> Show Labels<\/label><div style="padding-top: 10px;">Speedstep (max): <select id="cmbSpeedMax"><\/select>&nbsp;&nbsp;Time (max): <select id="cmbSpeedTimeMax"><\/select><\/div><\/div>')}function p(){window.addEventListener("resize",function(){h(!1);f()});y();__chkLabelShow=r.find(".chkLabelShow");__speedCurveRoot=r.find(".speedCurveRoot");__speedCurveRoot.get(0).onmousedown=function(){o=!0};__speedCurveRoot.get(0).onmouseup=function(){o=!1}}function w(){r.css({width:i.width+"px",height:i.height+"px"});const v=r.find(".speedCurveRoot");__lineSpeed=n("<div>").css({width:i.width+"px"}).addClass("speedCurveLineSpeed");__lineSpeed.appendTo(__speedCurveRoot);__lineTime=n("<div>").css({height:i.height+"px"}).addClass("speedCurveLineTime");__lineTime.appendTo(__speedCurveRoot);const y=i.width/u.speedsteps;let t=n();for(let i=0;i<u.speedsteps;++i){const r=n("<div>").css({width:u.noobyWidth+"px",height:u.noobyHeight+"px"}).data("index",i).data("xsteps",y).addClass("nooby_"+i).addClass("nooby"),f=n("<div>").addClass("noobySpeedLbl").html("");f.appendTo(r);const e=n("<div>").addClass("noobyTimeLbl").html("");e.appendTo(r);t=t.add(r)}v.append(t);h();const s=r.find("select#cmbSpeedMax");for(let t=0;t<u.speedsteps;++t){const i=n("<option>",{value:t}).html(t);i.appendTo(s)}s.change(function(){const t=n(this).val();i.speedStepMaxDefault=parseInt(t);b(t);f()});s.val(i.speedStepMaxDefault);const c=r.find("select#cmbSpeedTimeMax");for(let t=0;t<u.speedsteps;++t)if(t===i.speedTimeMaxDefault){const i=n("<option>",{value:t,selected:""}).html(t+"s");i.appendTo(c)}else{const i=n("<option>",{value:t}).html(t+"s");i.appendTo(c)}c.change(function(){i.speedTimeMaxDefault=n(this).val();f()});__speedCurveRoot.mouseleave(function(){o=!1});__speedCurveRoot.mousemove(function(n){n.preventDefault();const t=nt(this,n);(__recentMouseMoveCoord=t,o!==!1)&&a(t)});__speedCurveRoot.click(function(){a(__recentMouseMoveCoord)});const p=r.find("#cmdSpeedRestore"),w=r.find("#cmdSpeedLinear"),d=r.find("#cmdSpeedExponentialEsu"),g=r.find("#cmdSpeedExponentialLenz");p.click(function(){l(i.preloadData)});w.click(function(){k()});d.click(function(){e(0)});g.click(function(){e(1)});__chkLabelShow.click(function(){f()});f();typeof i.preloadData=="string"?i.preloadData==="esu"?e(0):i.preloadData==="lenz"&&e(1):i.preloadData.length===0?e(0):l(i.preloadData)}function f(){const y=r.find(".speedCurveRoot"),t=i.speedStepMaxDefault,p=i.speedTimeMaxDefault,w=r.find(".speedCurveLineSpeed"),b=r.find(".speedCurveLineTime"),l=r.find(".nooby_"+t);let f=parseInt(l.css("top").replace("px",""));f<0&&(f=f*-1);const k=i.height-f;w.css({top:k});let o=parseInt(l.css("left").replace("px",""));o+=u.noobyWidth/2;o+=t*u.noobyWidth;b.css({left:o});const nt=y.get(0).getBoundingClientRect(),s=r.find(".nooby");let e=1;s.length>32&&(e=10);const d=r.find(".chkLabelShow"),a=d.is(":checked"),g=p/t/e;let h=0;for(let r=0;r<s.length;r++){const c=n(s[r]),o=c.find(".noobyTimeLbl"),f=c.find(".noobySpeedLbl");o.hide();f.hide();let l=h.toString();l=l.substr(0,3);o.html(l+"s");const y=c.parent().get(0).getBoundingClientRect(),p=c.get(0).getBoundingClientRect(),w=y.bottom-p.bottom,b=i.height/u.speedsteps,v=1/b*w;f.html(v);o.removeClass("timeHighlight");f.removeClass("speedHighlight");c.data("speed",v);c.data("timeStep",h);v>t?(o.hide(),f.hide()):r===t?(o.addClass("timeHighlight"),f.addClass("speedHighlight"),f.html(t),o.show(),f.show()):r%e==0&&(a==!0?o.show():o.hide(),a==!0?f.show():f.hide());for(let n=0;n<e;++n)h+=g}if(i.onChanged!=null&&c===!0)i.onChanged({data:v()})}function b(t){const i=r.find(".nooby"),u=parseInt(t);for(let t=0;t<i.length;++t){const r=n(i[t]);r.removeClass("noobyMax");t===u&&r.addClass("noobyMax")}}function l(n=[]){typeof n=="string"?i.preloadData==="esu"?e(0):i.preloadData==="lenz"&&e(1):typeof n!="undefined"&&n!=null&&n.length>0&&d(n)}function k(){const e=r.find(".nooby"),t=u.speedsteps,o=i.height/t;for(let i=0;i<t;++i){const t=n(e[i]),r=i*o;s(t,r)}f()}function d(t){const e=r.find(".nooby"),o=u.speedsteps,h=i.height/o,c=t.length;for(let i=0;i<c;++i){const r=h*t[i],u=n(e[i]);s(u,r)}f()}function e(t,e=[]){const a=r.find(".nooby"),h=u.speedsteps,c=u.deltaShow;let o=e;h===14?t===0?o=[0,2,9.573,17.536,26.306,36.309,47.98,61.759,78.091,97.423,120.208,146.9,177.956,213.836]:t===1&&(o=[0,2,7.786,15.905,26.266,38.822,53.543,70.402,89.382,110.465,133.639,158.889,186.206,215.579]):t===0?o=[0,2,5.763,9.573,13.48,17.536,21.794,26.306,31.127,36.309,41.909,47.98,54.578,61.759,69.578,78.091,87.353,97.423,108.356,120.208,133.037,146.9,161.854,177.956,195.264,213.836,233.728,255]:t===1&&(o=[0,2,4.591,7.786,11.562,15.905,20.809,26.266,32.272,38.822,45.914,53.543,61.706,70.402,79.628,89.382,99.662,110.465,121.792,133.639,146.005,158.889,172.29,186.206,200.636,215.579,231.034,247]);const l=o.length;for(let t=0,r=0;t<l-1;++t,r+=c){const f=o[t],e=o[t+1];let u=r+c;t===l-2&&(u=h);const v=u-r,y=e-f,p=y/v;for(let t=r,e=0;t<u;++t,++e){const r=f+p*e,u=n(a[t]),o=i.height/255*r;s(u,o)}}f()}function g(){return{top:i.height,left:0}}function s(n,t){if(!(t<0)&&!(t>i.height)){const r=u.noobyHeight;n.css({top:-t-r+"px"})}}function h(t=true){const i=g(),f=r.find(".nooby");for(let r=0;r<f.length;++r){const e=n(f[r]),s=e.data("xsteps"),o=i.left+parseInt(r*s)-r*u.noobyWidth;t===!0?e.css({top:i.top+"px",left:o+"px"}):e.css({left:o+"px"})}}function a(n){const o=i.width/u.speedsteps,e=tt(n.x,i.width,o);if(!(e<0)){const t=r.find(".nooby_"+e);if(typeof t!="undefined"&&t!=null&&t.length!==0){const h=n.y;s(t,h);f()}}}function nt(n,t){const r=t.pageX,u=t.pageY,i=n.getBoundingClientRect(),f=i.top,e=i.left,o=i.height;return{x:r-e,y:o-(u-f),topPage:r-e,leftPage:o-(u-f)}}function tt(n,t,i){if(n<0||n>t)return-1;let r=0;for(let u=0;u<t;u+=i){const t=u,f=t+i;if(n>=t&&n<f)return r;++r}return-1}function v(){const f=r.find("select#cmbSpeedMax"),e=r.find("select#cmbSpeedTimeMax"),o=parseInt(f.val()),s=parseInt(e.val()),t=r.find(".nooby");let u=[];for(let i=0;i<t.length;++i){const e=n(t[i]);let r=e.data("speed"),f=e.data("timeStep");r<0&&(r=0);f<0&&(f=0);const o={speed:r,timeStep:f};u.push(o)}return{objectId:i.objectId,maxSpeed:o,maxTime:s,steps:u}}var c=!1;this.refresh=function(){return h(!1),f(),this};this.getData=function(){return v()};var i=n.extend({objectId:-1,speedMode:"dcc28",width:750,height:200,speedTimeMaxDefault:5,speedStepMaxDefault:null,preloadData:[],onChanged:null},t),u={dcc14:{speedsteps:14,extraWidthForSteps:2,noobyWidth:4,noobyHeight:4,deltaShow:1},dcc28:{speedsteps:28,extraWidthForSteps:2,noobyWidth:4,noobyHeight:4,deltaShow:2},dcc128:{speedsteps:128,extraWidthForSteps:2,noobyWidth:4,noobyHeight:4,deltaShow:4},mm14:{speedsteps:14,extraWidthForSteps:2,noobyWidth:4,noobyHeight:4,deltaShow:1},mm27:{speedsteps:27,extraWidthForSteps:0,noobyWidth:4,noobyHeight:4,deltaShow:2},mm128:{speedsteps:128,extraWidthForSteps:2,noobyWidth:4,noobyHeight:4,deltaShow:5}}[i.speedMode],r=this,o=!1;return i.speedStepMaxDefault==null&&(i.speedStepMaxDefault=parseInt(u.speedsteps/2)),p(),w(),c=!0,this}})(jQuery),function(n){n.fn.videoStream=function(t){function v(){u.resizable({ghost:!1,stop:function(n,t){typeof i.moved!="undefined"&&i.moved!=null&&i.moved({url:r.get(0).src,x:t.position.left,y:t.position.top,w:t.size.width,h:t.size.height})}});u.draggable({stop:function(n,t){typeof i.moved!="undefined"&&i.moved!=null&&i.moved({url:r.get(0).src,x:t.position.left,y:t.position.top,w:parseInt(u.css("width").replace("px","")),h:parseInt(u.css("height").replace("px",""))})}});u.css({width:i.width+"px",height:i.height+"px"});r=n("<img>",{width:i.width,height:i.height,src:i.url});r.appendTo(u);f=n("<div>").addClass("lblDateTime");const t=(new Date).toLocaleString("de-DE");f.html(t);f.appendTo(u);typeof i.caption!="undefined"&&i.caption!=null&&i.caption.length>0&&(e=n("<div>").addClass("lblCaption"),e.html(i.caption),e.appendTo(u));h();c=!0}function a(){r.get(0).src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGsAAABvCAYAAADrLj4aAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAASdEVYdFNvZnR3YXJlAEdyZWVuc2hvdF5VCAUAAAszSURBVHhe7V1VjBU9FN5n7BF7wAkOCR5cQ4LzwqLBnQTXEJIFNhBCFnfdYEFeSHB3t+DBg7u79f+/+Tv/3p09nWnnzl1u7/RLvrDc7XS2/e60p+ecdpKYgTYwYmkEI5ZGMGJpBE+xPnz4wFavXs2aNGnCypUrxypWrGgYBStVqsTKly/PkpOT2ebNm3kvy8FVrI8fP7IWLVqwpKQkwxgwT548rFOnTuzXr1+8x90hFOvNmzescuXK5E0Mg2WjRo3Y79+/ec+LIRSrd+/eZMWGsWFqairveTFIsS5fvszy589PVmoYG9aoUYM9ffqUK0CDFGvhwoVkhYax5enTp7kCNEixUlJSyMoMY8slS5ZwBWiQYk2YMIGsDCxYsCAbM2YMS0tLM1Rkv379yD61OX36dK4ADWWx2rZty37+/MlLGqjg4cOH1hqL6lcwcLFatmzJfvz4wUsaqODBgwdGLF1gxNIIRiyNYMTSCEasbMC3b98sX+nXr1/5J/5gxIoRYGYjNNS5c2fWunVrKzzUpk0b6//p6ens7t27vKQ8jFgxwLRp01w7FURsavLkyUp9YcQKEIgrtW/fnmy3iI0bN7aGSRkYsQIC4kkNGzYk2+zFWrVqsU+fPvGaxDBiBYRRo0aR7ZUl5jIvGLECQBDxu1y5crG9e/fyGmkYsQKAlzdclh06dGB//vzhtWaFEStKvHr1ilWtWpVsqyqLFi1qCSKCEStKXL9+neXLl49sqx+eO3eO15wVRqwogc6l2umXR44c4TVnhRErSly4cIFsp18eO3aM15wVRqwocfPmTVasWDGyrX4I8UUwYkUJZB3XqVOHbKsqq1Wrxp4/f85rzgojVgAYO3Ys2VZV9u/fn9dIw4gVAO7fv+/aiTKERXnt2jVeIw0jVkBAYmvOnDnJNstw3LhxvCYxjFgBYsiQIWSbvdi3b19egzuMWAEDMSrZJwzlvOapSBixYgA4ZBEVFomGz+vWrct27drFr5CDEStGQNYxvPFz585lw4YNY+3atbOGu6lTp1prKZn4lRNGLI1gxNIIRiyNYMTSCEYsjZDwYl26dImdPHnSSrrUHQktFjKOkIiC+yIjFlFdnZGwYvXq1SvLvZHjcObMGV5CPySkWN27dyfvDSJm9OLFC15SLySUWEhf7tq1K3nfSCJlWcd9zQkjFvLFcSwOdU+KGCazAyNHjrTOrxowYAD7/Pkz/9QfEkIshNZr165N3s+NU6ZM4TUEDzy5OJkg8n5w3mKfll9oL9bbt29950Dkzp2bLV++nNcULM6ePfu/JRrJevXq+RZMa7FgKKDx1H1kWaJECXb06FFeY3CAd526H4gvF0YDVWgr1pMnT1iDBg3Ie6gSHYCOCBIIh1D3soltPt+/f+el5aClWPBK+N0LJaLfbzsF7NWSORQTbXDbiOCEdmIhcIfFLVV3tMSuxSDw8uVLVqZMGfIeTnbr1o1f5Q2txMIRbUFmv1KEqR0tkKVbvHhxsn6KPXv25Fe6QxuxkAOu0gF+CQsRaWXRAI5jqm439unTh18thhZiHT582LLaqPpiQZjc+/fv53dXx7x588h6vah9Ri46rWTJkmRdsSSGW7e9Um4YPnw4WacMBw8ezGvJirgWa9WqVX9FKJv169e3djaqonnz5mR9MsTx37NmzeI1ZUbcigXPAuUByG7C3yh7bjrw+vVrVqVKFbIuWWLexFDqRFyKtXjxYusPpq7/G5SZ/G3cvn07EIsV7V+0aBGv9T/EnVjz58+PK6Fszp49m/+F7sDygrreD9EPy5Yt4zXHmVhz5syJS6FA/F0rVqzgf6kYCxYsIK93I55EpB2ULVvW+hesUKECy5Ejh0V7SIwbsWbOnGlNrtQ18UIsH9z2/AIjRowgr7WJfVjNmjWzfIcbNmywLE6ckPbo0SNr1yOc0/gZn8Gttn79eusLgLkQYpUqVYqsF8wWsQYOHEiWjUfim43OFEFkCSKWBU/8lStXfJ87CD8i3uwjCgnFXCwsBKly8Ux0FhX1RWwNojjLbty4MaqgoxNwOO/YsYO1atUqk8UcU7FgZVFldCDl9MXQhbkGv4ezGVZtUJ58ETCUYq7DPWMmFpyX1O91IvISI4HoMD7H3qw7d+7wT2MPvDCmY8eObOnSpfwTGr7EkslA0oHOtdCWLVusV1GpAMMj5kB46hH+uXjxIrt165YVXH337h0vJYcvX77wn2goixWrWNTfIuaMAwcOWO3GKxNlAKtu27ZtlrDVq1e3jJbIiAKOZIX5jkg4TlzbuXOnJV60UBYrEYn3MMLK8wKeHnS+ny8sRIXVjGMc/MKI9S+9ApaPHz9mEydODOT0NBgw2GQOy1MVoRcLuYFuOH78OKtZsyZ5bTRERED1uPFQi4XhzG1Yglkdy6Ap3FSHDh3id/NGqMVat24db3FWYCEsex4GhkcYFEiyAWFwyF4L3+HBgwf5Xd0RWrHwkmzReeywDr0OOIZAeMcwRMWZTc+ePbPMeGRG4WnFXjIcy4B4mpdwsCS93vcIhFas3bt389Zmxr1796TiWaJoMAXkoMDn6BaMldnKFEqxsAmC8g0iogx/HXWNk0hXUJlvACzA3Z4yrwV5KMUSpapt375dKR6H4QtpayqA110UJsGTh6dQhNCJlTdvXssd5ASO9/Gz7QhDJlxMKkD0WDQkYrgUIXRiwUlLAU8VVR50CxiCsARV3UmDBg0i64KI58+f56UyI3RiTZo0ibcyM6gN5yC2JMHo8NqapLpvy+300NGjR/NSmRE6sajd/gjHwxqjytv5E/Cs4wmiytjEMOrlOY+EqJ9FBlCoxMJ8dePGDd7KDJw6dYosj/kIHnYbGJ68nLgq24AQUqGsQ6zxKMdyqMTCk0Ed5S3KaMKC1nkqAHyFXhssevTowUu7AyEZ0fBK7eYMlVilS5cmA4KYx6jyOEKcgoyHQ/bcXNGmPWp5ESqxYAlSc8HQoUPJ8m6nAaxcudLVIwHC4vOCKI8FYRQnQiUWjk6l/IH4nCo/Y8YMXoIGPBJugiGPEomvbkhNTSWvTUlJ4SUyQIqFglQFuhMeccq8Fn05qQ5zwisL2Znn4YTKU02KJVJbd8LAQNTXCXQMVV52Q4NogWsTgmHYpOA8GMXmmjVreIkMkGLt2bOHrEB3IqROpZjh5dFUeax3ZE+Z9jqKoUCBAv8n5tiAl130VrwTJ07wUhkgxYJJ6cxMTRTi+G8nVNc7IsBkd9YRSUSdYfrbQNCRmvNE/ktSLAAH0SOK6axIdyIg6ATMedGXE28DlwUWw167JrHQtn1/otRz0QZAoVjApk2bEk6w5ORk3rrMEO0jxtCpkj4Gd5OX9x4+QcTCRNlSor1krmIBqBSmbRBpWPFAJGAi9O7Evn37hIFBWY+EDVicXtOIKBqNfr569SqvKTM8xQLgcsHYvXXrVmvtgQR6XQnPgGjLjmgIgzVHDZ9uQMgEiZ1UfW50ixZLiRUWIEorerogWFpaGi8pBwQlVbJ3RYaFDSOWA25vA4dg48ePV8qmRdhf9mQdUazNhhHLgffv33vON/CUI+eQmvucwDkcbmcX2pQ5AsKIRQBpzUWKFCE7NZIIWMLLgV0iCGoiVxDEXuK1a9daGxFk5i2vt7DaMGIJgCBl4cKFyc4VEfOdqtVcqFAh6aWBEcsFyJIVuYOCINZjKq/tMGJ5AP47kbPVL+Figomu+nY7I5YEMPHDoAjCX4qnCTv1/cCIpQCY7Onp6axp06ZKcxPK4i0PMDpUsp+cMGL5AKLNsPqQpgZXHPLjcZIafH6ImeFnbJTv0qWLFX7BQlflZDYRjFgawYilEYxY2oCxfwDgrfnWu3dlhQAAAABJRU5ErkJggg=="}function y(){let n=new Image;n.onload=function(){if(typeof r!="undefined"&&r!=null){r.get(0).src=this.src;const n=r.parent().get(0).getBoundingClientRect();r.css({width:n.width+"px",height:n.height+"px"});const t=(new Date).toLocaleString("de-DE");f.html(t);f.show();e.show();h()}};n.onerror=function(){if(i.stopOnFailure===!0&&(s++,s>=i.stopAfterFailuresFps)){console.log("Refresh of Stream stopped: "+s+" >= "+i.stopAfterFailuresFps);clearTimeout(o);o=-1;a();return}typeof r!="undefined"&&r!=null&&(a(),f.hide(),e.hide(),h())};n.src=i.url+"?t="+Math.random()}function h(){clearTimeout(o);o=setTimeout(function(){y()},1e3/i.fps)}var c=!1,u=this,r=null,f=null,e=null,o=-1,s=0,i;const l=10;return(i=n.extend({width:320,height:240,fps:l,locale:"de-DE",caption:"",stopOnFailure:!1,stopAfterFailuresFps:2*l,moved:null},t),c===!0)?this:(v(),this)}}(jQuery);class Accessories{constructor(){console.log("**** construct Accessories");this.__installed=!1;this.__gridName="gridAccessories";this.__dialogName="dialogAccessories";this.__storageNameGeometry=this.__dialogName+"_geometry";this.__windowGeometry=new WindowGeometryStorage(this.__dialogName);this.__initEventHandling();this.__recentlyHighlighted={}}__initEventHandling(){this.__events=new Events}on(n,t){this.__events.on(n,t)}__trigger(n,t){this.__events.triggerHandler(n,{sender:this,data:t})}show(){const n=$("#"+this.__dialogName);this.__windowGeometry.showWithGeometry(n);this.__installed?n.dialog("open"):(this.install({autoOpen:!0}),n.dialog("open"));w2ui[this.__gridName].refresh()}isShown(){try{return $("#"+this.__dialogName).dialog("isOpen")}catch(n){}return!1}__removeAllHighlights(){const n=this,t=Object.keys(n.__recentlyHighlighted);$(t).each(function(){window.planField.highlightAccessory(this,!1)});n.__recentlyHighlighted={}}install(n={}){const t=this,r=this.isShown();if(!r){(typeof n=="undefined"||typeof n.autoOpen=="undefined")&&(n==null&&(n={}),n.autoOpen=!1);const i=this.__windowGeometry.recent();if($("#"+this.__dialogName).dialog({height:i.height,width:i.width,left:i.left,top:i.top,autoOpen:n.autoOpen,resizeStop:function(n,i){t.__windowGeometry.save(i.position,i.size)},dragStop:function(n,i){t.__windowGeometry.save(i.position,{width:n.target.clientWidth,height:n.target.clientHeight})},close:function(){t.__removeAllHighlights();const n=w2ui[t.__gridName];n.selectNone()}}),!w2ui[this.__gridName]){const i=$("#"+this.__gridName);i.w2grid({name:this.__gridName,header:"Accessories",show:{toolbar:!0,footer:!0,toolbarAdd:!1,toolbarDelete:!1,toolbarEdit:!1,toolbarSave:!1},textSearch:"contains",recid:"accessoryId",searches:[{field:"identifier",caption:"Identifier",type:"text"}],sortData:[{field:"identifier",direction:"asc"}],columns:[{field:"accessoryId",caption:"Accessory ID",size:"2%",sortable:!1,hidden:!0},{field:"identifier",caption:"Identifier",size:"7%",sortable:!0},{field:"type",caption:"Type",size:"10%",sortable:!0},{field:"state",caption:"State",size:"10%",sortable:!1},{field:"addr1",caption:"Address1",tooltip:"Address1",size:"5%",sortable:!1,hidden:!0,render:"int",editable:{type:"int",min:0,max:32756}},{field:"port1",caption:"Port1",tooltip:"Port1",size:"5%",sortable:!1,hidden:!0,render:"int",editable:{type:"int",min:0,max:32756}},{field:"inverse1",caption:"Inverse1",tooltip:"Inverse1",size:"5%",sortable:!1,hidden:!0,editable:{type:"checkbox",style:"text-align: center"}},{field:"addr2",caption:"Address2",tooltip:"Address2",size:"5%",sortable:!1,hidden:!0,render:"int",editable:{type:"int",min:0,max:32756}},{field:"port2",caption:"Port2",tooltip:"Port2",size:"5%",sortable:!1,hidden:!0,render:"int",editable:{type:"int",min:0,max:32756}},{field:"inverse2",caption:"Inverse2",tooltip:"Inverse2",size:"5%",sortable:!1,hidden:!0,editable:{type:"checkbox",style:"text-align: center"}}],records:[],onSelect:function(n){const e=n.recid,r=w2ui[t.__gridName],u=r.get(e);t.__removeAllHighlights();window.planField.highlightAccessory(u.identifier,!0);t.__recentlyHighlighted[u.identifier]=!0;const f=r.getSelection();let i;const o=f.length;for(i=0;i<o;++i){const u=f[i],n=r.get(u);window.planField.highlightAccessory(n.identifier,!0);t.__recentlyHighlighted[n.identifier]=!0}},onUnselect:function(n){const r=n.recid,u=w2ui[t.__gridName],i=u.get(r);typeof i!="undefined"&&i!=null&&(window.planField.highlightAccessory(i.identifier,!1),t.__recentlyHighlighted[i.identifier]=!1)}});const n=w2ui[this.__gridName].toolbar;n&&(n.insert("search",{type:"check",id:"itemAddressing",text:"Address/Port",img:"fas fa-sitemap",checked:!1,tooltip:function(){return"Toogles the columns to set-up the accessory addressing."},onClick:function(){const n=w2ui[t.__gridName];n.toggleColumn("addr1");n.toggleColumn("port1");n.toggleColumn("inverse1");n.toggleColumn("addr2");n.toggleColumn("port2");n.toggleColumn("inverse2")}}),n.insert("search",{type:"button",id:"itemExecute",text:"Execute",img:"fas fa-exchange-alt",tooltip:function(){return"Switches the state of the current selected accessories."},onClick:function(){const r=w2ui[t.__gridName],i=r.getSelection();let n;const u=i.length;for(n=0;n<i.length;++n){const o=i[n],f=r.get(o),e=$("div.ctrlItemAccessory[id]");let u;const s=e.length;for(u=0;u<s;++u){const i=e[u];if(i){const n=$(i).data(constDataThemeItemObject);if(n!=null&&n.identifier===f.identifier){const i=n.coord;t.__trigger("accessoryExecute",{ctrlId:f.identifier,coord:i});break}}}}}}),n.add({type:"button",id:"cmdSave",text:"Save ",img:"fas fa-save",tooltip:function(){return"Applies all changes to the server."},onClick:function(){const n=w2ui[t.__gridName],i=n.getChanges();for(let r=0;r<i.length;++r){const f=i[r],h=f.recid,e=n.get(h);let o=!1,s=!1;typeof f.inverse1!="undefined"&&f.inverse1!=null&&(o=f.inverse1!=e.inverse1);typeof f.inverse2!="undefined"&&f.inverse2!=null&&(s=f.inverse2!==e.inverse2);let u={Addr1:f.addr1,Port1:f.port1,Inverse1:f.inverse1,Addr2:f.addr2,Port2:f.port2,Inverse2:f.inverse2};(typeof u.Addr1=="undefined"||u.Addr1==null)&&(u.Addr1=e.addr1);(typeof u.Port1=="undefined"||u.Port1==null)&&(u.Port1=e.port1);(typeof u.Inverse1=="undefined"||u.Inverse1==null)&&(u.Inverse1=e.inverse1);(typeof u.Addr2=="undefined"||u.Addr2==null)&&(u.Addr2=e.addr2);(typeof u.Port2=="undefined"||u.Port2==null)&&(u.Port2=e.port2);(typeof u.Inverse2=="undefined"||u.Inverse2==null)&&(u.Inverse2=e.inverse2);o===!0&&(e.inverse1=f.inverse1,n.refreshCell(e,"inverse1"));s===!0&&(e.inverse2=f.inverse2,n.refreshCell(e,"inverse2"));window.planField.applyAddressToAccessory(e.identifier,u);u.identifier=e.identifier;t.__trigger("setting",{mode:"accessory",cmd:"address",value:u})}t.__cleanupChangedState()}}))}this.__installed=!0}}__cleanupChangedState(){const n=this;$("#"+this.__dialogName+" td.w2ui-grid-data").each(function(){$(this).removeClass("w2ui-changed")})}removeAccessory(n){if(typeof n!="undefined"&&n!=null){const r=this,i=w2ui[r.__gridName],t=i.find({identifier:n});if(t.length>0){let n;const r=t.length;for(n=0;n<r;++n){const r=t[n];i.remove(r)}}}}updateAccessories(n){const o=this,t=n.metamodel;if(typeof t!="undefined"&&t!=null){const r=t.planField,u=w2ui[o.__gridName];let i=[],f=0;const e=Object.keys(r),s=e.length;for(let n=0;n<s;++n){const p=e[n],o=r[p],w=o.editor.themeId;if(isSwitchOrAccessory(w)){const s=f;++f;const b=o.identifier,k=o.name;let h=-1,c=-1,l=!1,a=-1,v=-1,y=!1;const t=o.addresses;typeof t=="undefined"||t==null||(h=t.Addr1,c=t.Port1,l=t.Inverse1,a=t.Addr2,v=t.Port2,y=t.Inverse2);const d=u.find({accessoryId:s});d.length<=0&&i.push({accessoryId:s,identifier:b,type:k,state:"unknown",addr1:h,port1:c,inverse1:l,addr2:a,port2:v,inverse2:y})}}i.length>0&&u.add(i)}}updateStates(n){const r=this,t=n.ecosData.accessories;if(typeof t!="undefined"&&t!=null){const u=$("div.ctrlItemAccessory"),i=w2ui[r.__gridName],f=t.length;for(let n=0;n<f;++n){const r=t[n];if(typeof r!="undefined"&&r!=null){const f=getAccByEcosAddr(u,r.addr);if(f!=null){const e=i.find({identifier:f.themeData.identifier});if(e.length>0){let n;const t=e.length;for(n=0;n<t;++n){const h=e[n],c=i.get(h);let t="straight",u="turn";const o=f.themeData.editor.themeId;isDecoupler(o)?(t="on",u="off"):isSignal(o)?(t="red",u="green"):isAccessory(o)&&(t="on",u="off");const l=c.state;let s;s=r.state===0?t:r.state===1?u:"unknown";l!==s&&(c.state=s,i.refreshCell(h,"state"))}}}}}}}}class Blocks{constructor(){console.log("**** construct Blocks");this.__installed=!1;this.winLocomotives=null;this.gridLocomotives=null;this.__gridName="gridBlocks";this.__dialogName="dialogBlocks";this.__storageNameGeometry=this.__dialogName+"_geometry";this.__windowGeometry=new WindowGeometryStorage(this.__dialogName);this.__initEventHandling();this.__fbsList=[]}__getFbsList(){return this.__fbsList}__initEventHandling(){this.__events=new Events}on(n,t){this.__events.on(n,t)}__trigger(n,t){this.__events.triggerHandler(n,{sender:this,data:t})}show(){const n=$("#"+this.__dialogName);this.__windowGeometry.showWithGeometry(n);this.__installed?n.dialog("open"):(this.install({autoOpen:!0}),n.dialog("open"));w2ui[this.__gridName].refresh()}isShown(){try{return $("#"+this.__dialogName).dialog("isOpen")}catch(n){}return!1}install(n={}){const t=this,r=this.isShown();if(!r&&!this.__installed){(typeof n=="undefined"||typeof n.autoOpen=="undefined")&&(n.autoOpen=!1);this.__expandedPreferences={};const i=this.__windowGeometry.recent();if($("#"+this.__dialogName).dialog({height:i.height,width:i.width,left:i.left,top:i.top,autoOpen:n.autoOpen,resize:function(){t.__resizePreferences()},resizeStop:function(n,i){t.__windowGeometry.save(i.position,i.size)},dragStop:function(n,i){t.__windowGeometry.save(i.position,{width:n.target.clientWidth,height:n.target.clientHeight})},close:function(){const n=w2ui[t.__gridName];n.selectNone()}}),!w2ui[this.__gridName]){const n=$("#"+this.__gridName);n.w2grid({name:this.__gridName,header:"Blocks and Feedbacks",multiSelect:!1,show:{toolbar:!0,footer:!0,toolbarAdd:!1,toolbarDelete:!1,toolbarEdit:!1,toolbarSave:!1,multiSelect:!1},textSearch:"contains",searches:[{field:"blockId",caption:"Block",type:"text"}],sortData:[{field:"blockId",direction:"asc"}],columns:[{field:"recid",caption:"ID",sortable:!1,hidden:!0},{field:"blockId",caption:"Block",size:"25%",sortable:!0},{field:"fbEnter",caption:"Feedback Enter",size:"20%",sortable:!0,editable:{type:"list",items:t.__getFbsList(),filter:!1}},{field:"fbIn",caption:"Feedback In",size:"20%",sortable:!1,editable:{type:"list",items:t.__getFbsList(),filter:!1}}],records:[],onExpand:function(n){const r=w2ui[t.__gridName];for(let t=0;t<r.records.length;++t){const i=r.records[t];typeof i!="undefined"&&i!=null&&i.recid!==parseInt(n.recid)&&r.collapse(i.recid)}const u=r.get(n.recid),i=t.__getExpandedHtml(u);i.recid=n.recid;i.blockId=u.blockId;i.fbEnterItemId=u.fbEnter;i.fbInItemId=u.fbIn;$("#"+n.box_id).html(i.renderHtml);t.__expandedPreferences[n.recid]=!0;n.onComplete=function(){const r=$("#"+i.selectId);if(typeof ecosData!="undefined"&&window.ecosData!=null){const n=window.ecosData.locomotives;for(let u=0;u<n.length;++u){const f=n[u],o=t.__isLocDenied(i.blockId,f.objectId),e=new Option(f.name,f.objectId,o,o);$(e).css({padding:"1px"});$(e).html(f.name);r.append(e)}}r.select2();r.on("select2:unselect",function(){t.__resizePreferences();t.__saveBlockSettings(i)});r.on("select2:select",function(){t.__resizePreferences();t.__saveBlockSettings(i)});const f=$("#"+i.fbEnterId),e=$("#"+i.fbInId);f.w2field("int");e.w2field("int");const o=i.checkboxIds;let u=[];for(let n=0;n<o.length;++n){const t=$("#"+o[n]);typeof t!="undefined"&&t!=null&&(t.w2field("checkbox"),u.push(t))}$("div#blockData_"+n.recid+" #"+i.selectId+" + span").css({"margin-left":"10px"});$("div#blockData_"+n.recid+" #"+i.selectId+" + span span.selection span.select2-selection").css({"border-radius":"3px",border:"1px solid #cacaca"});t.__loadRecentStatesFor(i.blockId,n.recid);f.change(function(){const n=getThemeJsonDataById(i.fbEnterItemId);n.addresses.Addr=parseInt($(this).val());setThemeJsonDataById(i.fbEnterItemId,n);t.__saveBlockSettings(i)});e.change(function(){const n=getThemeJsonDataById(i.fbInItemId);n.addresses.Addr=parseInt($(this).val());setThemeJsonDataById(i.fbInItemId,n);t.__saveBlockSettings(i)});for(let n=0;n<u.length;++n)u[n].change(function(){t.__saveBlockSettings(i)});t.__resizePreferences()}},onCollapse:function(n){t.__expandedPreferences[n.recid]=!1},onSelect:function(n){const i=w2ui[t.__gridName],r=i.get(n.recid);t.__addBlockFeedbackHiglight(r);const u=window.planField;u},onUnselect:function(){t.__removeBlockFeedbackHiglight()},onChange:function(n){const r=w2ui[t.__gridName],i=r.get(n.recid),u=n.column;if(u===2||u===3){let f="null",e="null";u===2?(i.fbEnter=n.value_new.text,f=i.fbEnter):u===3&&(i.fbIn=n.value_new.text,e=i.fbIn);t.__saveBlockFbs(i.blockId,f,e);r.refreshCell(i.recid,"fbEnter");r.refreshCell(i.recid,"fbIn");r.save();setTimeout(function(){t.__addBlockFeedbackHiglight(i)},250)}}})}this.__installed=!0}}__resizePreferences(){const n=this.__expandedPreferences;$.each(n,function(n,t){if(t===!0)try{const t=$("div#blockData_"+n).get(0).getBoundingClientRect().height;$("div#grid_gridBlocks_frec_"+n+"_expanded").css({height:t+"px"})}catch(i){}})}__saveBlockFbs(n,t,i){this.__trigger("setting",{mode:"block",cmd:"blockDataFbs",value:{blockIdentifier:n,fbEnterId:t,fbInId:i}})}__saveBlockSettings(n){const i=$("#"+n.selectId).select2("data");let t={};if(n.checkboxIds==null)t=null;else{const i=n.checkboxIds;for(let n=0;n<i.length;++n){const r=$("#"+i[n]);if(typeof r!="undefined"&&r!=null){const u=$(r).attr("name"),f=$(r).is(":checked");t[u]=f}}}this.__trigger("setting",{mode:"block",cmd:"blockData",value:{blockIdentifier:n.blockId,fbEnter:{id:n.fbEnterItemId,ecosAddr:parseInt($("#"+n.fbEnterId).val())},fbIn:{id:n.fbInItemId,ecosAddr:parseInt($("#"+n.fbInId).val())},deniedLocomotives:i,checkboxSettings:t}})}__getBlockOfRecentData(n){for(let i=0;i<this.__recentFeedbacksData.length;++i){var t=this.__recentFeedbacksData[i];if(typeof t!="undefined"&&t!=null&&t.BlockId===n)return t}return null}__isLocDenied(n,t){const i=this.__getBlockOfRecentData(n);if(i!=null){var r=i.DeniedLocomotives;for(let n=0;n<r.length;++n){const i=r[n];if(typeof i!="undefined"&&i!=null&&parseInt(i.Id)===t)return!0}}return!1}__loadRecentStatesFor(n,t){const i=this.__getBlockOfRecentData(n);if(i!=null){const n=this.__getCtrlIdsForOptionsAndTypes(t);$("#blockEnabled_"+t).prop("checked",i.Settings.BlockEnabled);$("#"+n.chkIdWait).prop("checked",i.Settings.OptionWait);$("#"+n.chkIdDirection).prop("checked",i.Settings.OptionDirection);$("#"+n.chkIdMainline).prop("checked",i.Settings.OptionMainline);$("#"+n.chkIdBbt).prop("checked",i.Settings.OptionBbt);$("#"+n.chkIdOthers).prop("checked",i.Settings.TypeOthers);$("#"+n.chkIdLocal).prop("checked",i.Settings.TypeLocal);$("#"+n.chkIdIntercity).prop("checked",i.Settings.TypeIntercity);$("#"+n.chkIdFreight).prop("checked",i.Settings.TypeFreight);$("#"+n.chkIdShunting).prop("checked",i.Settings.TypeShunting);$("#"+n.chkIdRegional).prop("checked",i.Settings.TypeRegional);$("#"+n.chkIdBranchLine).prop("checked",i.Settings.TypeBranchLine);$("#"+n.chkIdBranchLineFreight).prop("checked",i.Settings.TypeBranchLineFreight)}}__getExpandedHtml(n){const u=this,i=n.recid,f="blockData_"+i,e="blockFbEnter_"+i,o="blockFbAddr_"+i,s="selectDeniedLocomotives_"+i,y=getThemeJsonDataById(n.fbEnter),p=getThemeJsonDataById(n.fbIn);let t='<div id="'+f+'" style="padding: 5px; width: 100%; float: left;">',h=-1;try{h=y.addresses.Addr}catch(w){}let c=-1;try{c=p.addresses.Addr}catch(w){}t+='<div class="w2ui-field">';t+="<label>Feedback:<\/label>";t+='<div>Enter <input id="'+e+'" value="'+h+'" style="width: 75px;"> In <input id="'+o+'" value="'+c+'" style="width: 75px;"><\/div>';t+="<\/div>";t+='<div class="w2ui-field">';t+="<label>Denied Locs.:<\/label>";t+='<select name="selectDeniedLocomotives[]" id="'+s+'" multiple="multiple" style="width: 250px;">';t+="<\/select>";t+="<\/div>";const l="blockEnabled_"+i;t+=u.__getCheckboxHtml("Block Enabled:",l,"BlockEnabled",!0);const a=u.__getCheckboxOptions("Options:",i),v=u.__getCheckboxTypes("Types:",i);t+=a.html;t+=v.html;t+="<\/div>";let r=[];return r.push(l),r=r.concat(a.checkboxIds),r=r.concat(v.checkboxIds),{renderId:f,fbEnterId:e,fbInId:o,selectId:s,checkboxIds:r,renderHtml:t}}__getCtrlIdsForOptionsAndTypes(n){return{chkIdWait:"blockChkWait_"+n,chkIdDirection:"blockChkDirection_"+n,chkIdMainline:"blockChkMainline_"+n,chkIdBbt:"blockChkBbt_"+n,chkIdOthers:"blockChkTypeOthers_"+n,chkIdLocal:"blockChkTypeLocal_"+n,chkIdIntercity:"blockChkTypeIntercity_"+n,chkIdFreight:"blockChkTypeFreight_"+n,chkIdShunting:"blockChkTypeShunting_"+n,chkIdRegional:"blockChkTypeRegional_"+n,chkIdBranchLine:"blockChkTypeBranchLine_"+n,chkIdBranchLineFreight:"blockChkTypeBranchLineFreight_"+n}}__getCheckboxOptions(n,t){let i="";i+='<div class="w2ui-field">';i+="<label>"+n+"<\/label>";i+='<div style="padding-top: 7px;">';const u='style="word-wrap:break-word; font-weight: normal; margin-right: 10px;"',f='style="vertical-align: middle;"';var r=this.__getCtrlIdsForOptionsAndTypes(t);return i+="<label "+u+'><input name="OptionDirection" id="'+r.chkIdDirection+'" type="checkbox" '+f+"> Allow change direction <\/label>",i+="<label "+u+'><input name="OptionBbt" id="'+r.chkIdBbt+'" type="checkbox" '+f+"> Speed Curve <\/label>",i+="<\/div>",i+="<\/div>",{html:i,checkboxIds:[r.chkIdWait,r.chkIdDirection,r.chkIdMainline,r.chkIdBbt]}}__getCheckboxTypes(n,t){let r="";r+='<div class="w2ui-field">';r+="<label>"+n+"<\/label>";r+='<div style="padding-top: 7px;">';const u='style="word-wrap:break-word; font-weight: normal; margin-right: 10px;"',f='style="vertical-align: middle;"';var i=this.__getCtrlIdsForOptionsAndTypes(t);return r+="<label "+u+'><input name="TypeOthers" id="'+i.chkIdOthers+'" type="checkbox" '+f+"> Others <\/label>",r+="<label "+u+'><input name="TypeLocal" id="'+i.chkIdLocal+'" type="checkbox" '+f+"> Local <\/label>",r+="<label "+u+'><input name="TypeIntercity" id="'+i.chkIdIntercity+'" type="checkbox" '+f+"> Intercity <\/label>",r+="<label "+u+'><input name="TypeFreight" id="'+i.chkIdFreight+'" type="checkbox" '+f+"> Freight <\/label>",r+="<label "+u+'><input name="TypeShunting" id="'+i.chkIdShunting+'" type="checkbox" '+f+"> Shunting <\/label>",r+="<label "+u+'><input name="TypeRegional" id="'+i.chkIdRegional+'" type="checkbox" '+f+"> Regional <\/label>",r+="<label "+u+'><input name="TypeBranchLine" id="'+i.chkIdBranchLine+'" type="checkbox" '+f+"> Branch Line <\/label>",r+="<label "+u+'><input name="TypeBranchLineFreight" id="'+i.chkIdBranchLineFreight+'" type="checkbox" '+f+"> Branch Line (Freight) <\/label>",r+="<\/div>",r+="<\/div>",{html:r,checkboxIds:[i.chkIdOthers,i.chkIdLocal,i.chkIdIntercity,i.chkIdFreight,i.chkIdShunting,i.chkIdRegional,i.chkIdBranchLine,i.chkIdBranchLineFreight]}}__getCheckboxHtml(n,t,i,r=false){let f="";r===!0&&(f="checked");let u="";return u+='<div class="w2ui-field">',u+="<label>"+n+"<\/label>",u+='<div style="padding-top: 7px;"><input name="'+i+'" id="'+t+'" type="checkbox" '+f+"><\/div>",u+"<\/div>"}__addBlockFeedbackHiglight(n){const t=window.planField;if(t){toggleAllLocomotiveInformation(!1);var i=n.blockId,r=n.fbEnter,u=n.fbIn;const f=$("div.ctrlItemFeedback");f.each(function(){const n=$(this).attr("id");(n===r||n===u)&&$(this).addClass("highlightFeedback")});const e=$("div.ctrlItemBlock");e.each(function(){const n=$(this).attr("id");n===i&&($(this).addClass("highlightFeedbackBlock"),$(this).find("img").css({opacity:0}))})}}__removeBlockFeedbackHiglight(){const n=window.planField;if(n){toggleAllLocomotiveInformation(!0);const t=$("div.ctrlItemFeedback");t.each(function(){$(this).removeClass("highlightFeedback")});const i=$("div.ctrlItemBlock");i.each(function(){$(this).removeClass("highlightFeedbackBlock");$(this).find("img").css({opacity:1})})}}updateBlocks(n){const t=this,i=w2ui[t.__gridName];console.log(n)}updateFeedbacks(n){const u=this,f=w2ui[u.__gridName],i=n.data;u.__recentFeedbacksData=i;const r=[];let e=0,t;const o=i.length;for(t=0;t<o;++t){const n=i[t];if(typeof n!="undefined"&&n!=null){const u=f.find({blockId:n.BlockId});u.length===0&&(r.push({recid:e+1,blockId:n.BlockId,fbEnter:n.FbEnter,fbIn:n.FbIn}),++e)}}r.length>0&&f.add(r)}controlCreated(n){const t=this;try{const r=n.data(constDataThemeItemObject),u=isFeedback(r.editor.themeId);if(u===!1)return;const i=n.attr("id");t.__fbsList.includes(i)===!1&&t.__fbsList.push(i);const f=new Intl.Collator(undefined,{numeric:!0,sensitivity:"base"});t.__fbsList=t.__fbsList.sort(f.compare);t.__refreshFbCells()}catch(i){console.log(i)}}controlRemoved(n){const t=this,i=t.__fbsList.length;for(let r=0;r<i;r++)if(t.__fbsList[r]===n){t.__fbsList.splice(r,1);break}t.__refreshFbCells()}__refreshFbCells(){const n=this,t=w2ui[n.__gridName];t.columns[2].editable.items=n.__fbsList;t.columns[3].editable.items=n.__fbsList}clearGrid(){const n=this,t=w2ui[n.__gridName];n.__recentFeedbacksData=[];t.clear(!0);t.reset()}}class EcosHandler{constructor(){console.log("**** construct EcosHandler")}install(){}}class EditMenuBar{constructor(n={}){console.log("**** construct EditMenuBar");this.editMenu=$("#planField > div#planFieldItemEdit");this.cmdRotLeft=this.editMenu.find("div.rot-left");this.cmdRotRight=this.editMenu.find("div.rot-right");this.cmdRemove=this.editMenu.find("div.delete");this.cmdUngroup=this.editMenu.find("div.ungroup");this.options=n}rot(n,t,i=false){var e=getThemeJsonData(t),o=null,r=t.data(constDataThemeDimensionIndex),s,h,c;if(typeof r=="undefined"&&(r=0),s={w:1,h:1},h=1,typeof e.dimensions!="undefined"&&e.dimensions.length>0&&(s=e.dimensions[0],h=e.dimensions.length),s.w===1&&s.h===1?(o="center center",n===0?(++r,r>3&&(r=0)):n===1&&(--r,r<0&&(r=3))):(o="top left",n===0?r=r===1?0:1:n===1&&(r=r===0?1:0)),t.data(constDataThemeDimensionIndex,r),h>1){var u=null,f=null,l=r%4==0;i?l||(u=this.currentSelection.css("left"),f="calc( "+u+" + "+constItemWidth+"px)",this.currentSelection.css("left",f)):n>-1&&(l?(u=this.currentSelection.css("left"),f="calc( "+u+" - "+constItemWidth+"px)",this.currentSelection.css("left",f)):(u=this.currentSelection.css("left"),f="calc( "+u+" + "+constItemWidth+"px)",this.currentSelection.css("left",f)))}return c="rotate("+r*90+"deg)",this.currentSelection.css("transform-origin",o),this.currentSelection.css("transform",c),i||(this.updateEditMenuPositionAndEvents(t),h===1&&window.toolbox.rotate({themeId:e.id,themeDimIdx:r,transformOrigin:o,transform:c}),window.serverHandling.sendControl(this.currentSelection)),!0}setCurrentSelection(n){this.currentSelection=n;this.unbindMenuBar();const t=this;this.cmdRotLeft.click(function(n){n=n||window.event;n.preventDefault();n.stopPropagation();var i=t.rot(1,t.currentSelection);!i});this.cmdRotRight.click(function(n){n=n||window.event;n.preventDefault();n.stopPropagation();var i=t.rot(0,t.currentSelection);!i});this.cmdRemove.click(function(n){n=n||window.event;n.preventDefault();n.stopPropagation();t.hideEditMenu();var i=t.currentSelection.attr("id");t.currentSelection.remove();window.serverHandling.removeControl(i)});this.cmdUngroup.click(function(n){(n=n||window.event,n.preventDefault(),n.stopPropagation(),typeof planField!="undefined")&&window.planField.clearCtrlSelection()})}unbindMenuBar(){this.cmdRemove.unbind("click");this.cmdRotLeft.unbind("click");this.cmdRotRight.unbind("click")}updateEditMenuPositionAndEvents(n){var f;if(typeof n!="undefined"&&n!=null){const u=n.get(0),o=u.getBoundingClientRect().width,i=u.offsetLeft,r=u.offsetTop,s=i-constItemWidth/2,l=i+o+constItemWidth/2;f=$("div.ctrlItem[id]");const e=getCtrlOfPosition(s,r+10,f),h=getCtrlOfPosition(l,r+10,f);var a=parseInt(this.editMenu.width()),c=parseInt(this.editMenu.height()),t=!0;if(s<0?t=!1:e!=null&&h==null?t=!0:e==null&&h==null?t=!0:e==null&&(t=!1),t){const n=i-a-10,t=r-c/3;this.editMenu.css({left:n+"px",top:t+"px"})}else{const n=i+o+5,t=r-c/3;this.editMenu.css({left:n+"px",top:t+"px"})}}}hideEditMenu(){this.unbindMenuBar();this.editMenu.hide()}showEditMenu(){this.editMenu.show()}}const ErrorHandlerLevel={Info:1,Error:2};class ErrorHandler{constructor(){console.log("**** construct ErrorHandler");this.__overlay=$("div.overlay");this.__overlayText=$("div.overlay div.overlayText");this.setLevel(ErrorHandler.Info)}setLevel(n){typeof n=="undefined"&&(n=ErrorHandlerLevel.Info);var t="infoOverlay";switch(n){case ErrorHandlerLevel.Info:t="infoOverlay";break;case ErrorHandlerLevel.Error:t="errorOverlay"}this.__overlayText.removeClass("infoOverlay");this.__overlayText.removeClass("errorOverlay");this.__overlayText.addClass(t)}setText(n,t=false){var i=this.__overlay,r=this.__overlayText;i.is(":visible")?t&&r.html(n):(i.show(),r.html(n))}hide(){var n=this.__overlay,t=this.__overlayText;n.hide();t.html("")}}class Events{constructor(){this.__triggers={}}on(n,t){this.__triggers[n]||(this.__triggers[n]=[]);this.__triggers[n].push(t)}triggerHandler(n,t){if(this.__triggers[n])for(var i in this.__triggers[n])this.__triggers[n][i](t)}}class FeedbackVisualization{constructor(){console.log("**** construct FeedbackVisualization");this.__installed=!1;this.__dialogName="dialogFeedbackVisualization";this.__storageNameGeometry=this.__dialogName+"_geometry";this.__windowGeometry=new WindowGeometryStorage(this.__dialogName);this.__initEventHandling()}__initEventHandling(){this.__events=new Events}on(n,t){this.__events.on(n,t)}__trigger(n,t){this.__events.triggerHandler(n,{sender:this,data:t})}show(){const n=$("#"+this.__dialogName);this.__windowGeometry.showWithGeometry(n,!1);this.__installed?n.dialog("open"):(this.install({autoOpen:!0}),n.dialog("open"));typeof this.__recentSensorData!="undefined"&&this.__recentSensorData!=null&&this.updateFeedbackSensors(this.__recentSensorData)}isShown(){try{return $("#"+this.__dialogName).dialog("isOpen")}catch(n){}return!1}install(n={}){const t=this,r=this.isShown();if(!r&&!this.__installed){(typeof n=="undefined"||typeof n.autoOpen=="undefined")&&(n.autoOpen=!1);const i=this.__windowGeometry.recent();$("#"+this.__dialogName).dialog({left:i.left,top:i.top,resizable:!1,autoOpen:n.autoOpen,resizeStop:function(n,i){t.__windowGeometry.save(i.position,i.size)},dragStop:function(n,i){t.__windowGeometry.save(i.position,{width:0,height:0})},close:function(){}});this.__installed=!0}}updateFeedbackSensors(n){const r=this;if(r.__recentSensorData=n,r.isShown()!==!1){let u=0,t;const e=n.length;for(t=0;t<e;++t){const i=n[t];r.__addPort(t,u,i.ports);u+=i.ports}let i;const o=n.length;for(i=0;i<o;++i){const t=n[i];if(typeof t!="undefined"&&t!=null){for(let n=15;n>=0;--n){const u="div#feedbackPort_"+i+"_"+n,r=$(u),f=1<<n;(t.stateOriginal&f)!=0?r.removeClass("feedbackStateGreen").addClass("feedbackStateRed"):r.removeClass("feedbackStateRed").addClass("feedbackStateGreen")}u+=t.ports}}const s=$("div.feedbackOuterWrapper");s.css({height:n.length*45+"px"});const f=$("#"+this.__dialogName);f.dialog("option","width",490);f.dialog("option","height",n.length*50+30)}}__addPort(n,t,i){const s=$("div.feedbackOuterWrapper"),o="feedbackPort_"+n,u=$("div#"+o);u!=="undefined"&&u!=null&&u.length>0&&u.remove();const r=$("<div>").attr("id",o).css({width:"470px"}).addClass("feedbackPort"),h=$("<div>").css({display:"block",float:"left","padding-top":"4px","padding-right":"5px"}).html("Port "+(n+1));r.append(h);for(let u=0;u<i;++u){const e="feedbackPort_"+n+"_"+(i-u-1),f=$("<div>").attr("id",e).attr("data-tipso-title","Port("+(n+1)+")  Index("+(i-u-1)+")  EcosAddr("+(t+(i-u-1))+")").addClass("feedbackStateRed");r.append(f);f.tipso({size:"tiny",speed:100,delay:250,useTitle:!0,width:"auto",background:"#333333",titleBackground:"#333333"})}s.append(r);let f="",e="";i===16?(f="440px",e="-20px"):i===8&&(f="233px",e="-20px");const c=$("<div>").css({position:"relative","font-size":"0.75em",left:f,top:e,width:"20px",height:"20px",overflow:"visible","text-align":"right"}).html(t),l=$("<div>").css({position:"relative","font-size":"0.75em",left:"50px",width:"20px",height:"20px",overflow:"visible"}).html(t+i-1);r.append(l);r.append(c)}}const constItemWidth=32,constItemHeight=32,constDataThemeDimensionIndex="theme-dimension-index",constDataThemeItemObject="theme-item-object",constDataThemeId="theme-id",constKeyEnter=13,constKeyEscape=27,constGitWebsite="https://github.com/cbries/railessentials",ListOfFunctionDescription={2:"Function",3:"Light",4:"Light_0",5:"Light_1",7:"Sound",8:"Music",9:"Announce",10:"Routing Speed",11:"abv",32:"Coupler",33:"Steam",34:"Panto",35:"Highbeam",36:"Bell",37:"Horn",38:"Whistle",39:"Door Sound",40:"Fan",42:"Shovel Work Sound",44:"Shift",260:"Interior Lighting",261:"Plate Light",263:"Brakesound",299:"Crane Raise Lower",555:"Hook Up Down",773:"Wheel Light",811:"Turn",1031:"Steam Blow",1033:"Radio Sound",1287:"Coupler Sound",1543:"Track Sound",1607:"Notch up",1608:"Notch down",2055:"Thunderer Whistle",3847:"Buffer Sound"};class LightAndPower{constructor(){console.log("**** construct LightAndPower");this.__rgbStripesIpAddr="ws://192.168.178.66:81";this.__powerPlugIpAddr="ws://192.168.178.62:81";this.__installed=!1;this.__ctrlIdMorning="rgbColorMorning";this.__ctrlIdNoon="rgbColorNoon";this.__ctrlIdAfternoon="rgbColorAfternoon";this.__ctrlIdNight="rgbColorNight";this.__dialogName="dialogLightAndPower";this.__storageNameGeometry=this.__dialogName+"_geometry";this.__fieldNamePowerStates=this.__dialogName+"_powerStates";this.__windowGeometry=new WindowGeometryStorage(this.__dialogName);this.__initEventHandling()}__initEventHandling(){this.__events=new Events}on(n,t){this.__events.on(n,t)}__trigger(n,t){this.__events.triggerHandler(n,{sender:this,data:t})}show(){const n=$("#"+this.__dialogName);this.__windowGeometry.showWithGeometry(n,!1);this.__installed?n.dialog("open"):(this.install({autoOpen:!0}),n.dialog("open"))}isShown(){try{return $("#"+this.__dialogName).dialog("isOpen")}catch(n){}return!1}install(n={}){const t=this,e=this.isShown();if(!e&&!this.__installed){(typeof n=="undefined"||typeof n.autoOpen=="undefined")&&(n.autoOpen=!1);t.__c1DelayTimeout=0;t.__c2DelayTimeout=0;t.__c3DelayTimeout=0;t.__c4DelayTimeout=0;const r=[this.__ctrlIdMorning,this.__ctrlIdNoon,this.__ctrlIdAfternoon,this.__ctrlIdNight];let i;const o=r.length;for(i=0;i<o;++i){const n=$("#"+r[i]);n.colorpicker({stop:function(t,i){n.css({"background-color":i.css,color:i.css})}});var u=n.val();n.css({"background-color":"#"+u,color:"#"+u,"text-align":"left"});n.w2field("text")}$("#dialogLightAndPower input[type=eu-time]").w2field("time",{format:"h24"});const f=this.__windowGeometry.recent();$("#"+this.__dialogName).dialog({height:430,width:450,left:f.left,top:f.top,resizable:!1,autoOpen:n.autoOpen,resize:function(){},resizeStop:function(n,t){console.log(t)},dragStop:function(n,i){t.__windowGeometry.save(i.position,{})},close:function(){}});this.__applyRecentPowerSwitchStates(!0);this.__installed=!0}}__storePowerSwitchStates(){let n={in1:$("#powerChkIn1").is(":checked"),in2:$("#powerChkIn2").is(":checked"),in3:$("#powerChkIn3").is(":checked"),in4:$("#powerChkIn4").is(":checked")};$.localStorage.setItem(this.__fieldNamePowerStates,JSON.stringify(n))}__applyRecentPowerSwitchStates(n=false){const t=this,r=$("#powerChkIn1"),o=$("#powerChkIn1DelaySecs"),u=$("#powerChkIn2"),s=$("#powerChkIn2DelaySecs"),f=$("#powerChkIn3"),h=$("#powerChkIn3DelaySecs"),e=$("#powerChkIn4"),c=$("#powerChkIn4DelaySecs");n===!0&&(r.w2field("checkbox"),r.change(function(){t.__storePowerSwitchStates();t.__updatePowerDelayState(r,o);try{const n=$("#powerChkIn1DelaySpinner"),i=parseInt(o.val());r.is(":checked")?t.__c1DelayTimeout===0&&(n.show(),t.__c1DelayTimeout=setTimeout(function(){t.__sendPowerSwitch();clearTimeout(t.__c1DelayTimeout);t.__c1DelayTimeout=0;n.hide()},i*1e3)):(n.hide(),t.__sendPowerSwitch(),t.__c1DelayTimeout!==0&&(clearTimeout(t.__c1DelayTimeout),t.__c1DelayTimeout=0))}catch(n){}}),$("#powerChkIn1DelaySecs").w2field("int",{autoFormat:!0,min:0,max:30,silent:!1}),u.w2field("checkbox"),u.change(function(){t.__storePowerSwitchStates();t.__updatePowerDelayState(u,s);try{const n=$("#powerChkIn2DelaySpinner"),i=parseInt(s.val());u.is(":checked")?t.__c2DelayTimeout===0&&(n.show(),t.__c2DelayTimeout=setTimeout(function(){t.__sendPowerSwitch();clearTimeout(t.__c2DelayTimeout);t.__c2DelayTimeout=0;n.hide()},i*1e3)):(n.hide(),t.__sendPowerSwitch(),t.__c2DelayTimeout!==0&&(clearTimeout(t.__c2DelayTimeout),t.__c2DelayTimeout=0))}catch(n){}}),$("#powerChkIn2DelaySecs").w2field("int",{autoFormat:!0,min:0,max:30,silent:!1}),f.w2field("checkbox"),f.change(function(){t.__storePowerSwitchStates();t.__updatePowerDelayState(f,h);try{const n=$("#powerChkIn3DelaySpinner"),i=parseInt(h.val());f.is(":checked")?t.__c3DelayTimeout===0&&(n.show(),t.__c3DelayTimeout=setTimeout(function(){t.__sendPowerSwitch();clearTimeout(t.__c3DelayTimeout);t.__c3DelayTimeout=0;n.hide()},i*1e3)):(n.hide(),t.__sendPowerSwitch(),t.__c3DelayTimeout!==0&&(clearTimeout(t.__c3DelayTimeout),t.__c3DelayTimeout=0))}catch(n){}}),$("#powerChkIn3DelaySecs").w2field("int",{autoFormat:!0,min:0,max:30}),e.w2field("checkbox"),e.change(function(){t.__storePowerSwitchStates();t.__updatePowerDelayState(e,c);try{const n=$("#powerChkIn4DelaySpinner"),i=parseInt(c.val());e.is(":checked")?t.__c4DelayTimeout===0&&(n.show(),t.__c4DelayTimeout=setTimeout(function(){t.__sendPowerSwitch();clearTimeout(t.__c4DelayTimeout);t.__c4DelayTimeout=0;n.hide()},i*1e3)):(n.hide(),t.__sendPowerSwitch(),t.__c4DelayTimeout!==0&&(clearTimeout(t.__c4DelayTimeout),t.__c4DelayTimeout=0))}catch(n){}}),$("#powerChkIn4DelaySecs").w2field("int",{autoFormat:!0,min:0,max:30}),$("#rgbColorMorningRadio").w2field("radio"),$("#rgbColorNoonRadio").w2field("radio"),$("#rgbColorAfternoonRadio").w2field("radio"),$("#rgbColorNightRadio").w2field("radio"),$("#rgbColorMorningRadio").change(function(){t.__sendRgbStripe()}),$("#rgbColorNoonRadio").change(function(){t.__sendRgbStripe()}),$("#rgbColorAfternoonRadio").change(function(){t.__sendRgbStripe()}),$("#rgbColorNightRadio").change(function(){t.__sendRgbStripe()}));const l=$.localStorage.getItem(this.__fieldNamePowerStates);let i=JSON.parse(l);typeof i=="undefined"||i==null?i={in1:!1,in2:!1,in3:!1,in4:!1}:(r.prop("checked",i.in1),u.prop("checked",i.in2),f.prop("checked",i.in3),e.prop("checked",i.in3));t.__updatePowerDelayState(r,o);t.__updatePowerDelayState(u,s);t.__updatePowerDelayState(f,h);t.__updatePowerDelayState(e,c)}__updatePowerDelayState(n,t){const i=n.is(":checked");t.attr("disabled",i)}__sendRgbStripe(){const n=this,t=n.__getRgbStripesObject();n.__trigger("relayCommand",{mode:"websocket",target:this.__rgbStripesIpAddr,contentType:"application/json",data:t})}__getRgbStripesObject(){let n={r:255,g:255,b:255,w:1023};return $("#rgbColorMorningRadio").is(":checked")===!0?(n=hexToRgbA($("#rgbColorMorning").val()),n.w=200):$("#rgbColorNoonRadio").is(":checked")===!0?(n=hexToRgbA($("#rgbColorNoon").val()),n.w=1023):$("#rgbColorAfternoonRadio").is(":checked")===!0?(n=hexToRgbA($("#rgbColorAfternoon").val()),n.w=500):$("#rgbColorNightRadio").is(":checked")===!0&&(n=hexToRgbA($("#rgbColorNight").val()),n.w=100),n}__sendPowerSwitch(){const n=this,t={in1:$("#powerChkIn1").is(":checked"),in2:$("#powerChkIn2").is(":checked"),in3:$("#powerChkIn3").is(":checked"),in4:$("#powerChkIn4").is(":checked")};n.__trigger("relayCommand",{mode:"websocket",target:this.__powerPlugIpAddr,contentType:"application/json",data:t})}}const constLocomotiveControlBaseName="locomotiveCtrl_",constLocomotiveMinSpeed=0;class LocomotiveControl{constructor(){console.log("**** construct LocomotiveControl");this.__tplMain="./components/dialogLocomotiveControl/locomotiveControl.html";this.__baseDlgId=constLocomotiveControlBaseName;this.__dlgId=null;this.__dlgElement=null;this.__dlgIsClosed=!0;this.__windowGeometry=null;this.__locomotiveRecord=null;this.__speedTrigger=!0;this.__initEventHandling()}__initEventHandling(){this.__events=new Events}on(n,t){this.__events.on(n,t)}__trigger(n,t){this.__events.triggerHandler(n,{sender:this,data:t})}updateSpeedState(n){if(!this.__dlgIsClosed){var t=this.__dlgElement.find(".locomotiveSpeedometer");t&&(this.__speedTrigger=!1,t.slider("value",n.speedstep),this.__speedTrigger=!0,$(".locomotiveSpeedstepValue").html(n.speedstep))}}updateFunctionStates(n){for(var u,f,e,o,s=n.objectId,h=n.nrOfFunctions,c=n.funcset,i=n.funcdesc,r=0,t=0;t<i.length;++t)if((u=c[t],f=i[t],f.type!==0)&&(e="fncCommand_"+s+"_"+t,o=$("button."+e),this.__changeButtonStyle(o,u==="1"),++r,r>=h))break}__changeButtonStyle(n,t){t?n.css({"font-weight":"bold",color:"green"}):n.css({"font-weight":"bold",color:"red"})}open(n){const t=this;this.__locomotiveRecord=n;const r=this.__locomotiveRecord.name,s=this.__locomotiveRecord.speedstep,u=this.__locomotiveRecord.oid,h=this.__locomotiveRecord.noOfFunctions,c=this.__locomotiveRecord.funcset,l=this.__locomotiveRecord.funcdesc;this.__dlgId=this.__baseDlgId+u;this.__dlgSelector="#"+this.__dlgId;this.__windowGeometry=new WindowGeometryStorage(this.__dlgId);const v=$(this.__dlgSelector);if(v.length>0)return!1;this.__dlgIsClosed=!1;const y=$("div[id=tplLocomotiveControl]");let i=y.clone();this.__dlgElement=i;i.attr("id",this.__dlgId);i.attr("title",r);i.addClass("locomotiveControlMain");i.dialog({height:350,resizable:!1,autoOpen:!1,resizeStop:function(n,i){t.__windowGeometry.save(i.position,i.size)},dragStop:function(n,i){t.__windowGeometry.save(i.position,{width:n.target.clientWidth,height:n.target.clientHeight})},close:function(){i.remove();t.__trigger("dialogClosed",{instance:this})}});const p=i.find(".locomotiveSpeedometer");p.slider({orientation:"vertical",range:"min",min:constLocomotiveMinSpeed,max:t.__locomotiveRecord.speedstepMax,value:s,slide:function(n,t){$(".locomotiveSpeedstepValue").html(t.value)},stop:function(n,i){if(t.__speedTrigger){const r=t.__locomotiveRecord.oid;t.__trigger("speedChanged",{oid:r,speedstep:i.value})}}});$(".locomotiveSpeedstepValue").html(s);const a="img_"+this.__dlgId,f=i.find(".locomotiveImage");f.attr("id",a);f.attr("src","./images/noimage32x32.png");f.attr("alt",r);loadLocomotiveImageIntoHtml(a,r);const w=function(n){const i=$(n.currentTarget).data("function"),r=t.__locomotiveRecord.oid;t.__trigger("functionChanged",{oid:r,fncIdx:i,timestamp:Date.now()})},b=function(n){const i=$(n.currentTarget).data("speedstep"),r=t.__locomotiveRecord.oid;t.__trigger("speedChanged",{oid:r,speedstep:i,timestamp:Date.now()})},e={"font-size":"14px","font-weight":"bold",width:"50px",padding:"2px",margin:"2px"},k=i.find("button").not("button[data-function]");k.each(function(){$(this).button();$(this).data("speedstep")?($(this).css(e),$(this).click(b)):$(this).data("direction")&&($(this).css(e),$(this).css({width:"25px",display:"inline-block",margin:"-3px","margin-bottom":"2px"}),$(this).click(function(){const n=t.__locomotiveRecord.oid;t.__trigger("directionChanged",{oid:n,force:$(this).data("direction")})}))});const d=getArrayOfFunctions2(u,h,c,l),g=i.find("td.locomotiveCommandField");let o=0;for(let n=0;n<c.length;++n){const f=d[o],r=l[n];if(r.type!==0){const s="fncCommand_"+u+"_"+n;let t=$("<button>").text("F"+n);t.addClass("locomotiveCommand");t.addClass(s);t.data("function",n);let i=ListOfFunctionDescription[r.type];if((typeof i=="undefined"||i==null)&&(i="Function"),t.data("tipso-title",i),t.button(),t.css(e),this.__changeButtonStyle(t,f.state),t.click(w),t.appendTo(g),t.tipso({size:"tiny",speed:100,delay:250,useTitle:!0,width:"auto",background:"#333333",titleBackground:"#333333"}),++o,o>=h)break}}return i.dialog("open"),!0}}class Locomotives{constructor(){console.log("**** construct Locomotives");this.winLocomotives=null;this.gridLocomotives=null;this.__locomotiveImages={};this.__recentEcosData=null;this.__installed=!1;this.__gridName="gridLocomotives";this.__dialogName="dialogLocomotives";this.__storageNameGeometry=this.__dialogName+"_geometry";this.__windowGeometry=new WindowGeometryStorage(this.__dialogName);this.__initEventHandling()}__initEventHandling(){this.__events=new Events}on(n,t){this.__events.on(n,t)}__trigger(n,t){this.__events.triggerHandler(n,{sender:this,data:t})}show(){const n=$("#"+this.__dialogName);this.__windowGeometry.showWithGeometry(n);this.__installed?n.dialog("open"):(this.install({autoOpen:!0}),n.dialog("open"));this.updateLocomotives(this.__recentEcosData);w2ui[this.__gridName].refresh()}isShown(){try{return $("#"+this.__dialogName).dialog("isOpen")}catch(n){}return!1}__handleLocomotiveFunctionToggle(){}__renderImage(n){const t="loadLocomotivesImage_"+n.oid;loadLocomotiveImageIntoHtml(t,n.name);return'<div style="height: 100%; width: 100%; white-space: nowrap; text-align: center; padding-top: 3px;"><span style="display: inline-block;height: 100%;vertical-align: middle;"><\/span><img id="'+t+'" style="height: 16px; width: 16px; margin: auto;" src="./images/noimage32x32.png" /><\/div>'}__renderFunctions(n){const i=n.noOfFunctions;if(i==0)return"<b>&mdash;<\/b>";const r=window.getArrayOfFunctions(n);let t="";return $(r).each(function(){const n=this;let i=ListOfFunctionDescription[n.type];typeof i=="undefined"&&(i="Unknown");const r={oid:n.oid,fncIdx:n.idx,timestamp:Date.now()},u=window._htmlEntities(JSON.stringify(r)),f="fncCommand_"+n.oid+"_"+n.idx,e="onClick=\"window.__eventTrigger('functionChanged', '"+u+"');\"",o=n.state?"checked":"";t+='<input class="'+f+'" type="checkbox" '+o+" "+e+' title="'+i+'">'}),t}getLocomotiveRecord(n){if(n<=0||!w2ui[this.__gridName])return null;const i=w2ui[this.__gridName],t=i.find({oid:n});if(typeof t!="undefined"&&t!=null&&t.length>0){const n=t[0];return i.get(n)}return null}install(n={}){const t=this,u=this.isShown();if(!u){typeof n.autoOpen=="undefined"&&(n.autoOpen=!1);this.__gridRowDoubleBlickCount=0;this.__expandedPreferences={};const i=this.__windowGeometry.recent();if($("#"+this.__dialogName).dialog({height:i.height,width:i.width,left:i.left,top:i.top,autoOpen:n.autoOpen,resizeStop:function(n,i){t.__windowGeometry.save(i.position,i.size)},dragStop:function(n,i){t.__windowGeometry.save(i.position,{width:n.target.clientWidth,height:n.target.clientHeight})}}),!w2ui[this.__gridName]){const n=$("#"+this.__gridName);n.w2grid({name:this.__gridName,header:"Locomotives",multiSelect:!1,show:{toolbar:!0,footer:!0,toolbarAdd:!1,toolbarDelete:!1,toolbarEdit:!1,toolbarSave:!1},dragRow:!0,textSearch:"contains",recid:"oid",searches:[{field:"name",caption:"Name",type:"text"}],sortData:[{field:"name",direction:"asc"}],columns:[{field:"oid",caption:"Object ID",size:"10%",sortable:!0},{field:"locImage",caption:"Photo",size:"10%",style:"text-align: center",render:t.__renderImage},{field:"name",caption:"Name",size:"30%",sortable:!0,editable:{type:"text"}},{field:"protocol",caption:"Protocol",size:"10%",sortable:!0},{field:"addr",caption:"Address",size:"10%"},{field:"speed",caption:"Speed",size:"10%",hidden:!0},{field:"speedstep",caption:"Speedstep",size:"10%",hidden:!1},{field:"speedstepMax",caption:"Speedstep (max)",size:"10%",hidden:!1},{field:"funcset",caption:"Functions",size:"15%",render:t.__renderFunctions},{field:"funcdesc",caption:"Func.-Desc.",hidden:!0},{field:"noOfFunctions",caption:"No. of Functions",hidden:!0},{field:"locked",caption:"Locked",size:"10%",style:"text-align: center",editable:{type:"checkbox",style:"text-align: center"}}],records:[],onExpand:function(n){if(t.__gridRowDoubleBlickCount!==0){--t.__gridRowDoubleBlickCount;n=n||window.event;n.preventDefault();n.stopPropagation();return}const r=w2ui[t.__gridName],u=r.get(n.recid),i=t.__getExpandedHtml(u);i.recid=n.recid;$("#"+n.box_id).html(i.renderHtml);t.__expandedPreferences[n.recid]=!0;n.onComplete=function(){const u=i.checkboxIds;let r=[];for(let n=0;n<u.length;++n){const t=$("#"+u[n]);typeof t!="undefined"&&t!=null&&(t.w2field("checkbox"),r.push(t))}const f=$("#"+i.blockCurrentId);f.w2field("list",{items:[]});$("div#locomotivesData_"+n.recid+" #"+i.selectId+" + span").css({"margin-left":"10px"});$("div#locomotivesData_"+n.recid+" #"+i.selectId+" + span span.selection span.select2-selection").css({"border-radius":"3px",border:"1px solid #cacaca"});t.__loadRecentStatesFor(n.recid);f.change(function(){t.__saveLocomotiveSettings(i)});for(let n=0;n<r.length;++n)r[n].change(function(){t.__saveLocomotiveSettings(i)});const e=$("#cmdSpeedCurveContainer_"+n.recid);e.w2field("button");e.click(function(){const i=n.recid;t.__showSpeedCurveDialog(i)});t.__resizePreferences()}},onCollapse:function(n){t.__expandedPreferences[n.recid]=!1},onDblClick:function(n){t.__gridRowDoubleBlickCount++;const i=w2ui[t.__gridName],r=n.column,u=i.columns[r];if(u.field==="name"){n.stopPropagation();return}const f=i.get(n.recid);t.__trigger("locomotiveDoubleClick",f)}})}const r=w2ui[t.__gridName].toolbar;r&&r.add({type:"button",id:"cmdSave",text:"Save ",img:"fas fa-save",tooltip:function(){return"Applies all changes to the server."},onClick:function(){const n=w2ui[t.__gridName],i=n.getChanges();for(let r=0;r<i.length;++r){const o=i[r],h=o.recid,u=n.get(h),s=u.oid,f=o.name;typeof f!="undefined"&&f!=null&&(u.name=f,n.refreshCell(u,"name"),t.__trigger("setting",{mode:"locomotive",cmd:"rename",value:{oid:s,name:f}}));const e=o.locked;typeof e!="undefined"&&e!=null&&(u.locked=e,n.refreshCell(u,"locked"),t.__trigger("setting",{mode:"locomotive",cmd:"lock",value:{oid:s,locked:e}}))}t.__cleanupChangedState()}});this.__installed=!0}}__getLocomotiveEcosData(n){const t=this;if(typeof t.__recentEcosData=="undefined"||t.__recentEcosData==null)return null;const i=parseInt(n);for(let n=0;n<t.__recentEcosData.length;++n){const r=t.__recentEcosData[n];if(r!=null&&r.objectId===i)return r}return null}__showSpeedCurveDialog(n){const t=this;console.log("Locomotive Object ID: "+n);w2ui.formSpeedCurve||$().w2form({name:"formSpeedCurve",style:"border: 0px; background-color: white;",formHTML:'<div class="w2ui-page page-0">    <div id="formSpeedCurveInstance" class="speedCurveDesign"><\/div><\/div><div class="w2ui-buttons">    <button class="w2ui-btn" name="cancel">Cancel<\/button>    <button class="w2ui-btn" name="save">Save<\/button><\/div>',fields:[],record:{},actions:{save:function(){const n=t.__speedCurveInstance.getData(),i=n.objectId;delete n.objectId;t.__saveLocomotiveSpeedCurve(i,n);w2popup.close()},cancel:function(){w2popup.close()}}});$().w2popup("open",{title:"SpeedCurve",body:'<div id="form" style="width: 100%; height: 100%;"><\/div>',style:"padding: 0px 0px 0px 0px; padding-left: 5px; background-color: white;",width:775,height:400,showMax:!1,onToggle:function(n){$(w2ui.foo.box).hide();n.onComplete=function(){$(w2ui.foo.box).show();w2ui.foo.resize()}},onOpen:function(i){i.onComplete=function(){$("#w2ui-popup #form").w2render("formSpeedCurve");const r=t.__getLocomotiveEcosData(n);let e="dcc128",u=55,f=15;r!=null&&(r.protocol==="DCC128"||r.protocol==="MM128"||r.protocol==="MFX"?(e="dcc128",u=55,f=15):r.protocol==="MMFKT"||r.protocol==="MM14"||r.protocol==="DCC14"?(e="dcc14",u=7,f=5):(r.protocol==="MM27"||r.protocol==="DCC28")&&(e="dcc28",u=7,f=5));const i=t.__getLocomotiveOfRecentData(n);let o="esu";if(i!=null&&i.SpeedCurve!=null){if(typeof i.SpeedCurve.steps!="undefined"&&i.SpeedCurve.steps!=null){o=[];for(let n=0;n<i.SpeedCurve.steps.length;++n)o.push(i.SpeedCurve.steps[n].speed)}typeof i.SpeedCurve.maxSpeed!="undefined"&&(u=i.SpeedCurve.maxSpeed);typeof i.SpeedCurve.maxTime!="undefined"&&(f=i.SpeedCurve.maxTime)}t.__speedCurveInstance=$("#w2ui-popup #formSpeedCurveInstance").speedCurve({objectId:n,speedMode:e,speedStepMaxDefault:u,speedTimeMaxDefault:f,height:220,preloadData:o});t.__speedCurveInstance.refresh()}}})}__resizePreferences(){const n=this.__expandedPreferences;$.each(n,function(n,t){if(t===!0)try{const t=$("div#locomotivesData_"+n).get(0).getBoundingClientRect().height;$("div#grid_gridLocomotives_frec_"+n+"_expanded").css({height:t+"px"})}catch(i){}})}__saveLocomotiveSpeedCurve(n,t){typeof t!="undefined"&&t!=null&&this.__trigger("setting",{mode:"locomotive",cmd:"speedCurve",value:{oid:n,data:t}})}__saveLocomotiveSettings(n){const t={},i=n.checkboxIds;for(let n=0;n<i.length;++n){const r=$("#"+i[n]);if(typeof r!="undefined"&&r!=null){const u=$(r).attr("name"),f=$(r).is(":checked");t[u]=f}}const r=n.recid;this.__trigger("setting",{mode:"locomotive",cmd:"locomotiveData",value:{oid:r,checkboxSettings:t}})}__cleanupChangedState(){const n=this;$("#"+this.__dialogName+" td.w2ui-grid-data").each(function(){$(this).removeClass("w2ui-changed")})}updateLocomotives2(n){const i=this,r=w2ui[i.__gridName],t=n.data;this.__recentLocomotivesData=t;for(let n in t)if(t.hasOwnProperty(n)){const i=parseInt(n),u=r.get(i);if(typeof u=="undefined"||u==null)continue;u.locked!==t[i].IsLocked&&(u.locked=t[i].IsLocked,r.refreshCell(i,"locked"))}i.__cleanupChangedState()}updateLocomotives(n){const u=this;if(u.__recentEcosData=n,typeof n!="undefined"&&n!=null){const t=w2ui[u.__gridName];let r=[],i;const f=this.__recentEcosData.length;for(i=0;i<f;++i){const n=this.__recentEcosData[i];if(typeof n!="undefined"&&n!=null){const u=n.objectId,f=n.name,c=n.protocol,e=n.addr,l=n.speed,o=n.speedstep,a=n.speedstepMax,s=n.funcset,v=n.funcdesc,h=n.nrOfFunctions,y=t.find({oid:u});if(y.length<=0)r.push({oid:u,name:f,protocol:c,addr:e,speed:l,speedstep:o,speedstepMax:a,noOfFunctions:h,locked:!1,funcset:s,funcdesc:v});else{const i=t.get(u),c=function(){const n=constLocomotiveControlBaseName+u;return window.findLocomotivesDlg(n)},r=c();i.name!==f&&(i.name=f,t.refreshCell(u,"name"));i.addr!==e&&(i.addr=e,t.refreshCell(u,"addr"));i.speedstep!==o&&(i.speedstep=o,t.refreshCell(u,"speedstep"),r&&r.updateSpeedState(n));i.noOfFunctions!==h&&(i.noOfFunctions=h,t.refreshCell(u,"noOfFunctions"));i.funcset!==s&&(i.funcset=s,t.refreshCell(u,"funcset"),r&&r.updateFunctionStates(n))}}}r.length>0&&t.add(r)}}__getExpandedHtml(n){const u=this,r=n.oid,f="locomotivesData_"+r;let t='<div id="'+f+'" style="padding: 5px; width: 100%; float: left;">';const e=u.__getCheckboxOptions("Options:",r),o=u.__getCheckboxTypes("Types:",r);t+=e.html;t+=o.html;t+='<div class="w2ui-field">';t+="<label>Speed Curve:<\/label>";t+='<input type="button" id="cmdSpeedCurveContainer_'+r+'" value="Modify" style="padding: 2px; margin-top: 3px; margin-left: 5px;"><\/div>';t+="<\/div>";t+="<\/div>";let i=[];return i=i.concat(e.checkboxIds),i=i.concat(o.checkboxIds),{renderId:f,checkboxIds:i,renderHtml:t}}__getCtrlIdsForOptionsAndTypes(n){return{chkIdDirection:"locomotiveChkDirection_"+n,chkIdMainline:"locomotiveChkMainline_"+n,chkIdOthers:"locomotiveChkTypeOthers_"+n,chkIdLocal:"locomotiveChkTypeLocal_"+n,chkIdIntercity:"locomotiveChkTypeIntercity_"+n,chkIdFreight:"locomotiveChkTypeFreight_"+n,chkIdShunting:"locomotiveChkTypeShunting_"+n,chkIdRegional:"locomotiveChkTypeRegional_"+n,chkIdBranchLine:"locomotiveChkTypeBranchLine_"+n,chkIdBranchLineFreight:"locomotiveChkTypeBranchLineFreight_"+n}}__getCheckboxOptions(n,t){let i="";i+='<div class="w2ui-field">';i+="<label>"+n+"<\/label>";i+='<div style="padding-top: 7px;">';const r=this.__getCtrlIdsForOptionsAndTypes(t);return i+='<label style="word-wrap:break-word; font-weight: normal; margin-right: 10px;"><input name="OptionDirection" id="'+r.chkIdDirection+'" type="checkbox" style="vertical-align: middle;"> Allow change direction <\/label>',i+="<\/div>",i+="<\/div>",{html:i,checkboxIds:[r.chkIdDirection,r.chkIdMainline,]}}__getCheckboxTypes(n,t){let r="";r+='<div class="w2ui-field">';r+="<label>"+n+"<\/label>";r+='<div style="padding-top: 7px;">';const u='style="word-wrap:break-word; font-weight: normal; margin-right: 10px;"',f='style="vertical-align: middle;"',i=this.__getCtrlIdsForOptionsAndTypes(t);return r+="<label "+u+'><input name="TypeOthers" id="'+i.chkIdOthers+'" type="checkbox" '+f+"> Others <\/label>",r+="<label "+u+'><input name="TypeLocal" id="'+i.chkIdLocal+'" type="checkbox" '+f+"> Local <\/label>",r+="<label "+u+'><input name="TypeIntercity" id="'+i.chkIdIntercity+'" type="checkbox" '+f+"> Intercity <\/label>",r+="<label "+u+'><input name="TypeFreight" id="'+i.chkIdFreight+'" type="checkbox" '+f+"> Freight <\/label>",r+="<label "+u+'><input name="TypeShunting" id="'+i.chkIdShunting+'" type="checkbox" '+f+"> Shunting <\/label>",r+="<label "+u+'><input name="TypeRegional" id="'+i.chkIdRegional+'" type="checkbox" '+f+"> Regional <\/label>",r+="<label "+u+'><input name="TypeBranchLine" id="'+i.chkIdBranchLine+'" type="checkbox" '+f+"> Branch Line <\/label>",r+="<label "+u+'><input name="TypeBranchLineFreight" id="'+i.chkIdBranchLineFreight+'" type="checkbox" '+f+"> Branch Line (Freight) <\/label>",r+="<\/div>",r+="<\/div>",{html:r,checkboxIds:[i.chkIdOthers,i.chkIdLocal,i.chkIdIntercity,i.chkIdFreight,i.chkIdShunting,i.chkIdRegional,i.chkIdBranchLine,i.chkIdBranchLineFreight]}}__getLocomotiveOfRecentData(n){if(typeof this.__recentLocomotivesData=="undefined"||this.__recentLocomotivesData==null)return null;const t=this.__recentLocomotivesData[n];return typeof t=="undefined"||t==null?null:t}__loadRecentStatesFor(n){const i=this,t=this.__getLocomotiveOfRecentData(n);if(t!=null){const i=this.__getCtrlIdsForOptionsAndTypes(n);$("#"+i.chkIdDirection).prop("checked",t.Settings.OptionDirection);$("#"+i.chkIdMainline).prop("checked",t.Settings.OptionMainline);$("#"+i.chkIdOthers).prop("checked",t.Settings.TypeOthers);$("#"+i.chkIdLocal).prop("checked",t.Settings.TypeLocal);$("#"+i.chkIdIntercity).prop("checked",t.Settings.TypeIntercity);$("#"+i.chkIdFreight).prop("checked",t.Settings.TypeFreight);$("#"+i.chkIdShunting).prop("checked",t.Settings.TypeShunting);$("#"+i.chkIdRegional).prop("checked",t.Settings.TypeRegional);$("#"+i.chkIdBranchLine).prop("checked",t.Settings.TypeBranchLine);$("#"+i.chkIdBranchLineFreight).prop("checked",t.Settings.TypeBranchLineFreight)}this.updateOccInformation(this.__recentOcc)}updateBlockInformation(n){const t=this,r=w2ui[t.__gridName],i=n.data;this.__recentFeedbacksData=i}updateOccInformation(){const n=this}}class Occ{constructor(){console.log("**** construct Occ");this.__secondsToWaitAfterBlockReach=10;this.__divRootClass="locomotiveInfo";this.__divFromClass="locomotiveInfoFrom";this.__divNextClass="locomotiveInfoNext";this.__divFinalClass="locomotiveInfoFinal";this.__dataOidName="locoid";this.__divBlockedClass="isblocked";this.__borderPaddingLeft=0;this.__borderPaddingTop=0;this.__borderPaddingRight=4;this.__initEventHandling()}__initEventHandling(){this.__events=new Events}on(n,t){this.__events.on(n,t)}__trigger(n,t){this.__events.triggerHandler(n,{sender:this,data:t})}getLocomotiveInfo(n){const u=this,t=$("div."+this.__divRootClass);if(typeof t=="undefined"||t==null||t.length===0)return null;let i;const r=t.length;for(i=0;i<r;++i){const r=t[i];if(r!=null){const u=$(r).data(this.__dataOidName);if(typeof u!="undefined"&&u!=null&&u===n)return r}}return null}__generateLocomotiveInfoIdentifiers(n){const t=this;return{root:"locomotiveInfo"+n,rootNext:"locomotiveInfoNext"+n,rootFinal:"locomotiveInfoFinal"+n,image:"locomotiveInfoImage"+n,imageNext:"locomotiveInfoImageNext"+n,imageFinal:"locomotiveInfoImageFinal"+n}}__createLocomotiveInfo(n){const t=this,e=t.__generateLocomotiveInfoIdentifiers(n.objectId);let i=$("<div>",{}).css({"z-index":50,position:"absolute",overflow:"hidden",height:"28px","max-height":"28px","line-height":"28px",display:"inline-block","vertical-align":"middle","font-weight":"bold",cursor:"pointer","text-align":"center"}).attr("id",e.root).data(this.__dataOidName,n.objectId);i.attr("unselectable","on");i.attr("onselectstart","return false;");i.attr("onmousedown","return false;");i.addClass(this.__divRootClass);i.addClass(this.__divFromClass);const s=$("<div>").css({position:"absolute",top:"0",left:"0"}).addClass("locInfoLabel").html(n.name);s.appendTo(i);let h=$("<i>").css({display:"none",position:"absolute",right:"1px",top:"18px",color:"red","font-size":"0.6rem"}).addClass("fas fa-lock").addClass("lockState");h.appendTo(i);let c=$("<i>").css({display:"none",position:"absolute",left:"1px",top:"18px",color:"red","font-size":"0.6rem"}).addClass("fas fa-hand-paper").addClass("isStoppedState");c.appendTo(i);let l=$("<i>").css({display:"none"}).addClass("fas fa-long-arrow-alt-right").addClass("enterSide");l.appendTo(i);let u=i.clone();u.attr("id",e.rootNext);u.removeClass(this.__divFromClass);u.addClass(this.__divNextClass);const a=u.find("img");a.attr("id",e.imageNext);u.dblclick(function(){t.__trigger("resetAssignment",{mode:"resetAssignment",submode:"next",oid:n.objectId})});let f=i.clone();f.attr("id",e.rootFinal);f.removeClass(this.__divFromClass);f.addClass(this.__divFinalClass);const v=f.find("img");v.attr("id",e.imageFinal);f.dblclick(function(){t.__trigger("resetAssignment",{mode:"resetAssignment",submode:"final",oid:n.objectId})});let y=$("<div>").css({display:"none","text-align":"center",position:"absolute",left:"0px",top:"0px",color:"black","background-color":"lightgray","font-size":"1.0rem",width:i.css("width"),height:i.css("height")}).addClass("countdown").html('<i class="fas fa-history" style="padding-right: 5px;"><\/i><span class="countdown">...<\/span>');y.appendTo(i);i.draggable({opacity:.7,helper:"clone",start:function(){const n=t.__getPlanfieldClickControlOfPosition();n!==null&&(t.__dragStartBlockElement=n)},stop:function(){var r=!1;try{const i=t.__getPlanfieldClickControlOfPosition();if(typeof i=="undefined"||i===null)throw"resetAssignment";if(!i.hasClass("ctrlItemBlock"))throw"resetAssignment";if(i.hasClass(this.__divBlockedClass))throw"reset";const r=t.__dragStartBlockElement,f=r.attr("id"),e=i.attr("id");if(f===e)throw"reset";const o=getThemeJsonData(r),u=getThemeJsonData(i);if(!isBlock(u.editor.themeId))throw"reset";t.__trigger("gotoBlock",{mode:"gotoBlock",oid:n.objectId,fromBlock:o.coord,toBlock:u.coord})}catch(e){e==="reset"?r=!0:e==="resetAssignment"&&(i.hide(),u.hide(),f.hide(),t.__trigger("resetAssignment",{mode:"resetAssignment",oid:n.objectId}))}finally{r;t.__dragStartBlockElement=null}}});const p=$("div[id=tplLocomotiveInfoCtrl]");var r=p.find("div.locInfoCtrl").clone();r.css({display:"none"});r.attr("id","locCtrl_"+n.objectId);r.find("#locSpeedPlus").click(function(){t.__trigger("speedChanged",{oid:n.objectId,speedstep:"++",timestamp:Date.now()})});r.find("#locSpeedMinus").click(function(){t.__trigger("speedChanged",{oid:n.objectId,speedstep:"--",timestamp:Date.now()})});r.find("#locSpeedStop").click(function(){t.__trigger("speedChanged",{oid:n.objectId,speedstep:"level0",timestamp:Date.now()})});r.find("#locOpenDialog").click(function(){const i=n.objectId;t.__trigger("openLocomotiveControl",{oid:i})});r.find("#locBackward").click(function(){t.__trigger("directionChanged",{oid:n.objectId,force:"backward"})});r.find("#locForward").click(function(){t.__trigger("directionChanged",{oid:n.objectId,force:"forward"})});const w=r.find(".locSpeedSteps").find("button").not("button[data-function]");w.each(function(){$(this).button();$(this).data("speedstep")&&$(this).click(function(i){const r=$(i.currentTarget).data("speedstep");t.__trigger("speedChanged",{oid:n.objectId,speedstep:r,timestamp:Date.now()})})});i.mouseover(function(){(clearTimeout(t.__timeoutBeforeHide),t.__timeoutBeforeHide=0,t.__timeoutBeforeShow>0)||t.isLocomotiveControlHoverShown(this)||($(".locInfoCtrl").each(function(){$(this).hide()}),t.__timeoutBeforeShow=setTimeout(function(){t.showLocomotiveControlHover(i)},250))});i.mouseleave(function(){clearTimeout(t.__timeoutBeforeShow);t.__timeoutBeforeShow=0;t.__timeoutBeforeHide=setTimeout(function(){t.hideLocomotiveControlHover(i)},250)});i.on("dblclick",function(n){n.preventDefault();const r=i.data("oid");t.__saveLocomotiveStart(r,!0)});i.on("contextmenu",function(n){n.preventDefault();const r=i.data("oid"),u=t.__getLocomotiveOfRecentData(r);let o="",s="";u.EnterBlockSide==="'+' Side"?o="fas fa-check":u.EnterBlockSide==="'-' Side"?s="fas fa-check":o="fas fa-check";let f="",e="";u.IsLocked===!0?(e="Unlock Locomotive",f="fas fa-lock",i.data("isLocked",!0)):u.IsLocked===!1?(e="Lock Locomotive",f="fas fa-lock-open",i.data("isLocked",!1)):(e="Unlock Locomotive",f="fas fa-lock",i.data("isLocked",!0));const h=i.data("isLocked");new Contextual({isSticky:!1,items:[{cssIcon:"fas fa-play",enabled:window.__autoModeState,label:"Start",onClick:()=>{t.__saveLocomotiveStart(r,!0)}},{cssIcon:"fas fa-stop",enabled:window.__autoModeState,label:"Finalize",onClick:()=>{t.__stopWaitCounter(r),t.__saveLocomotiveFinalize(r,!0)}},{type:"seperator"},{cssIcon:o,label:'Enter "+"',onClick:()=>{i.data("enterSide","Plus"),t.__saveLocomotiveEnterSide(r,"'+' Side")}},{cssIcon:s,label:'Enter "-"',onClick:()=>{i.data("enterSide","Minus"),t.__saveLocomotiveEnterSide(r,"'-' Side")}},{type:"seperator"},{cssIcon:f,label:e,onClick:()=>{i.data("isLocked",!h),t.__saveLocomotiveLock(r,!h)}}]})});const o=$("body");r.appendTo(o);i.appendTo(o);u.appendTo(o);f.appendTo(o);t.__updateStateVisualization(n.objectId)}__stopWaitCounter(n){if(typeof n!="undefined"&&n!=null&&!(n<=0)){const t=$("#locomotiveInfo"+n+" div.countdown");t.hide()}}__updateTimeVisualization(n){if(typeof n!="undefined"&&n!=null){const i=this,u=new Date(n.ReachedTime).getTime();i.__secondsToWaitAfterBlockReach=n.SecondsToWait;const f=parseInt((new Date).getTime()/1e3),e=f-(parseInt(u/1e3)+i.__secondsToWaitAfterBlockReach),o=e>0,s=n.Oid,t=$("#locomotiveInfo"+s+" div.countdown");if(o===!0)t.hide();else{if(t.is(":visible"))return;t.show();let n=t.find("span.countdown");n.data("secsToWait",i.__secondsToWaitAfterBlockReach);n.html(i.__secondsToWaitAfterBlockReach+"s");var r=function(n){setTimeout(function(){const t=n.find("span.countdown"),i=t.data("secsToWait")-1;if(isNaN(i)||i<1){t.data("secsToWait",0);n.hide();return}t.data("secsToWait",i);t.html(i+"s");r(n)},1e3)};r(t)}}}__getLocomotiveOfRecentData(n){if(typeof this.__recentLocomotivesData=="undefined"||this.__recentLocomotivesData==null)return null;const t=this.__recentLocomotivesData[n];return typeof t=="undefined"||t==null?null:t}__fncScaleLbl(n,t){try{const i=n.find("div.locInfoLabel");if(!i.is(":visible"))return;if(i.width()===0||i.height()===0)return;i.boxfit();const u=i.find("span");let r=u.css("font-size");r=parseInt(r.replace("px",""));u.css("font-size",parseInt(r*t)+"px");n.data("fontIsScaled",!0)}catch(i){}}__updateStateVisualization(n){const r=this,o=r.__generateLocomotiveInfoIdentifiers(n),t=$("#"+o.root);if(typeof t!="undefined"&&t!=null&&t.length!==0){const u=r.__getLocomotiveOfRecentData(n);if(u==null){r.__fncScaleLbl(t,.75);return}const i=t.find(".enterSide");if(typeof i!="undefined"&&i!=null&&i.length>0){let n="";u.EnterBlockSide.includes("'+'")?n="plus":u.EnterBlockSide.includes("'-'")&&(n="minus");i.removeAttr("style");n==="plus"?(i.css({position:"absolute",right:"2px",top:"1px",color:"yellow","font-size":"0.7rem",transform:"scaleX(1)"}),i.show()):n==="minus"?(i.css({position:"absolute",left:"2px",top:"1px",color:"yellow","font-size":"0.7rem",transform:"scaleX(-1)"}),i.show()):i.hide()}const f=t.find(".lockState");typeof f!="undefined"&&f!=null&&f.length>0&&(u.IsLocked===!1?(f.hide(),r.__fncScaleLbl(t,.7)):(f.show(),r.__fncScaleLbl(t,.7)));const e=t.find(".isStoppedState");typeof e!="undefined"&&e!=null&&e.length>0&&(u.IsStopped===!1?e.hide():e.show())}}__saveLocomotiveStart(n,t){this.__trigger("setting",{mode:"locomotive",cmd:"start",value:{oid:n,state:t}})}__saveLocomotiveFinalize(n,t){this.__trigger("setting",{mode:"locomotive",cmd:"finalize",value:{oid:n,state:t}})}__saveLocomotiveLock(n,t){this.__trigger("setting",{mode:"locomotive",cmd:"lock",value:{oid:n,locked:t}})}__saveLocomotiveEnterSide(n,t){this.__trigger("setting",{mode:"locomotive",cmd:"locomotiveData",value:{oid:n,checkboxSettings:null,blockEnterSide:t}})}isLocomotiveControlHoverShown(n){const t=$(n).data(this.__dataOidName),i=$("#locCtrl_"+t);return i.is(":visible")}showLocomotiveControlHover(n){const i=this,f=$(n).data(this.__dataOidName),t=$("#locCtrl_"+f);t.show();const r=n.get(0),e=r.offsetLeft,o=r.offsetTop,s=n.get(0).getBoundingClientRect().height,u=t.get(0).getBoundingClientRect(),h=u.height,c=u.width,l=parseInt(h-s)/2;t.css({top:o-l+"px",left:e-c-4+"px"});t.mousemove(function(){clearTimeout(i.__timeoutBeforeHide);i.__timeoutBeforeHide=0});t.mouseleave(function(){setTimeout(function(){t.hide()},100)})}hideLocomotiveControlHover(n){const t=$(n).data(this.__dataOidName),i=$("#locCtrl_"+t);i.hide()}loadLocomotives(n){const t=this;t.__recentLocomotives=n;for(let i=0;i<n.length;++i)if(n[i]!==null){const r=n[i],u=r.objectId,f=t.getLocomotiveInfo(u);f==null&&t.__createLocomotiveInfo(r)}}resetAssignment(){console.log("reset assignment")}__getBlock(n){const i=this,t=$("div.ctrlItemBlock");for(let i=0;i<t.length;++i){const r=t[i];if(typeof r!="undefined"&&r!=null){const u=getThemeJsonData($(r));if(typeof u!="undefined"&&u!=null&&u.identifier===n)return $(r)}}return null}__applyInfoToBlock(n,t,i){(typeof i=="undefined"||i==null)&&(i=null);const o=this;if(typeof t!="undefined"&&t!=null){const e=t.get(0).getBoundingClientRect(),s=e.width,h=e.top+this.__borderPaddingTop+"px",c=e.left+this.__borderPaddingLeft+"px";let u=0,f=0;s<=64?(u=2*constItemWidth-this.__borderPaddingRight+"px",f=2*constItemWidth-this.__borderPaddingRight+"px"):(u=4*constItemWidth-this.__borderPaddingRight+"px",f=4*constItemWidth-this.__borderPaddingRight+"px");n.css({top:h,left:c,width:u,"max-width":f,"text-align":"left"});var r=n.find("div");typeof r!="undefined"&&r!=null&&r.length>0&&(r.css("width",u),r.css("max-width",f),r.css("height",constItemHeight));i!=null&&(n.data("oid",i.Oid),o.__updateStateVisualization(i.Oid));t.addClass(o.__divBlockedClass)}}handleData(n){const t=this,r=n.data;var f=[];let i;const u=r.length;for(i=0;i<u;++i){const n=r[i];f.push(n.Oid)}const e=$("div.locomotiveInfo");for(u===0?e.each(function(){$(this).hide()}):e.each(function(){const n=$(this),t=n.data(this.__dataOidName);f.includes(t)||n.hide()}),i=0;i<u;++i){const n=r[i];if(typeof n!="undefined"&&n!=null){const s=t.__generateLocomotiveInfoIdentifiers(n.Oid),h=$("div#"+s.root),c=$("div#"+s.rootNext),u=$("div#"+s.rootFinal),f=n.FromBlock,e=n.NextBlock,o=n.FinalBlock;if(typeof f=="undefined"||f==null||f.length===0)h.hide();else{const i=t.__getBlock(f);h.show();t.__applyInfoToBlock(h,i,n)}if(typeof e=="undefined"||e==null||e.length===0)c.hide();else{const n=t.__getBlock(e);c.show();t.__applyInfoToBlock(c,n)}if(typeof o=="undefined"||o==null||o.length===0)u.hide();else{const n=t.__getBlock(o);u.show();t.__applyInfoToBlock(u,n);t.__fncScaleLbl(u,.9)}const l=n.FinalEntered;typeof l!="undefined"&&l!=null&&(l===!0?u.find("div.locInfoLabel").addClass("locomotiveInfoFinalEntering"):u.find("div.locInfoLabel").removeClass("locomotiveInfoFinalEntering"));t.__updateTimeVisualization(n)}}}updateOccWithLocomotiveData(n){const i=this,t=n.data;this.__recentLocomotivesData=t;for(let n in t)if(t.hasOwnProperty(n)){const t=parseInt(n);i.__updateStateVisualization(t)}}__getPlanfieldClickControlOfPosition(){const n=window.planField.planfieldElement.get(0),t=event.clientX-n.offsetLeft,i=event.clientY-n.offsetTop,r=$("div.ctrlItem[id]");return getCtrlOfPosition(t,i,r)}}"use strict";class Planfield{constructor(n={}){console.log("**** construct Planfield");this.planfieldElement=null;this.isEditMode=!1;typeof n.isEditMode!="undefined"&&(this.isEditMode=n.isEditMode);this.currentSelection=null;this.currentSelectionMoved=!1;this.currentSelectionMovedItem=null;this.options=n;this.__initEventHandling()}__initEventHandling(){this.__events=new Events}on(n,t){this.__events.on(n,t)}__trigger(n,t){this.__events.triggerHandler(n,{sender:this,data:t})}setEditMode(n){const e=this;this.isEditMode=n;this.clearCtrlSelection();n?this.planfieldElement.addClass("planFieldBackground"):this.planfieldElement.removeClass("planFieldBackground");let t;const u=window.textfieldElementInstances.length;for(t=0;t<u;++t)window.textfieldElementInstances[t].setEditMode(n);const r=$("div.ctrlItem");let i;const f=r.length;for(i=0;i<f;++i){const t=r[i];t!=null&&(n?this.initDragFor($(t)):this.removeDragFor($(t)))}}__updatePlanfieldGeometryPixel(n={}){typeof n.w=="undefined"&&(n.w=$(window).width());typeof n.h=="undefined"&&(n.h=$(window).height());this.__updatePlanfieldGeometry(parseInt(n.w/constItemWidth),parseInt(n.h/constItemHeight))}__updatePlanfieldGeometry(n,t){const i=$("div#planField");return i.css("width","calc("+n+" * "+constItemWidth+"px + 1px)"),i.css("height","calc("+t+" * "+constItemHeight+"px + 1px)"),i}isCtrlSelected(n){if(typeof n=="undefined"||n==null)return!1;n instanceof jQuery||(n=$(n));const t=n.find("img");return typeof t=="undefined"?!1:t==null?!1:t.hasClass("selected")}__getCtrl(n,t){const i=n.x,r=n.y,u=i*constItemWidth+constItemWidth/2,f=r*constItemHeight+constItemHeight/2,e=getCtrlOfPosition(u,f,t);return $(e)}clearRouteUserHighlight(){const t=this,n=$("div.ctrlItem");if(typeof n!="undefined"&&n!=null&&n.length!==0)for(let t=0;t<n.length;++t){const i=n[t];i!=null&&$(i).removeClass("highlightRoute")}}activateRouteUserHighlight(n){const r=this,u=$("div.ctrlItem");let t,i=n.tracks.length;for(t=0;t<i;++t){const i=r.__getCtrl(n.tracks[t],u);i.addClass("highlightRoute")}for(i=n.sensors.length,t=0;t<i;++t){const i=r.__getCtrl(n.sensors[t],u);i.addClass("highlightRoute")}for(i=n.signals.length,t=0;t<i;++t){const i=r.__getCtrl(n.signals[t],u);i.addClass("highlightRoute")}for(i=n.switches.length,t=0;t<i;++t){const i=r.__getCtrl(n.switches[t],u);i.addClass("highlightRoute")}}activateRouteVisualization(n){const t=[];Array.prototype.push.apply(t,n.tracks);Array.prototype.push.apply(t,n.sensors);Array.prototype.push.apply(t,n.signals);Array.prototype.push.apply(t,n.switches);const r=this,u=$("div.ctrlItem");let i;const f=t.length;for(i=0;i<f;++i){const e=t[i];if(e!=null){const o=r.__getCtrl(e,u),n=o.find("img");if(typeof n!="undefined"&&n!=null&&n.length!==0){let f=n.attr("src");f.includes("-route.png")||(f=f.replace(".png","-route.png"),n.attr("src",f))}}}}deativateRouteVisualization(n){const t=[];Array.prototype.push.apply(t,n.tracks);Array.prototype.push.apply(t,n.sensors);Array.prototype.push.apply(t,n.signals);Array.prototype.push.apply(t,n.switches);const r=this,u=$("div.ctrlItem");let i;const f=t.length;for(i=0;i<f;++i){const e=t[i];if(e!=null){const o=r.__getCtrl(e,u),n=o.find("img");if(typeof n!="undefined"&&n!=null&&n.length!==0){let f=n.attr("src");f.includes("-route.png")&&(f=f.replace("-route.png",".png"),n.attr("src",f))}}}}clearCtrlSelection(){const n=$("div.ctrlItem");if(typeof n!="undefined"&&n!=null&&n.length!==0){let t;const i=n.length;for(t=0;t<i;++t){const i=n[t];i!=null&&this.isCtrlSelected(i)&&this.unselectCtrl($(i))}}}unselectCtrl(n){if(typeof n!="undefined"&&n!=null){let t=n.find("img");(typeof t=="undefined"&&(t=null),t!=null)&&(t.removeClass("selected"),this.editMenubar.hideEditMenu(),this.currentSelection=null)}}selectCtrl(n,t={}){if(typeof n!="undefined"&&n!=null){this.clearCtrlSelection();const i=n.find("img");typeof i!="undefined"&&i!=null&&i.addClass("selected");this.currentSelection=n;typeof t.startEditMode=="undefined"&&(t.startEditMode=!0);t.startEditMode&&(this.editMenubar.setCurrentSelection(n),this.editMenubar.updateEditMenuPositionAndEvents(n),this.editMenubar.showEditMenu())}}generateUniqueItemIdentifier(n){const i=$("div.ctrlItem[id]").map(function(){return this.id}).get();let t="Item";n&&(n>=10&&n<=25?t="TK":n>=50&&n<=75?t="SW":n>=100&&n<=125?t="SE":n>=150&&n<=175?t="BK":n>=200&&n<=225&&(t="FB"));const r=i.length;for(let n=0;n<r;++n){const r=t+"_"+n;if(!i.includes(r))return r}return t+"_"+r}install(){const n=this;n.__firstRun=!0;window.ctrlClickSpinnerCounter=0;$(window).resize(function(){n.__updatePlanfieldGeometryPixel()});this.editMenubar=new EditMenuBar(this.options);this.__updatePlanfieldGeometryPixel();this.planfieldElement=$("div#planField");this.planfieldElement.click(function(t){if(n.currentSelectionMoved){t.preventDefault();t.stopPropagation();n.currentSelectionMoved=!1;return}const i=getCtrlOfEvent($(this),t,$("div.ctrlItem"));if(i!=null){const u=i.data(constDataThemeItemObject);if(typeof u!="undefined"&&u!==null&&u.clickable&&!n.isEditMode){const f=$("div.lds-facebookOriginal"),u=f.clone();u.removeClass("lds-facebookOriginal");u.addClass("lds-facebook");const e="lfd-facebookClickId"+window.ctrlClickSpinnerCounter;if(u.addClass(e),++window.ctrlClickSpinnerCounter,u.css({top:t.clientY-constItemHeight/2,left:t.clientX-constItemWidth/2}),u.insertAfter(f),!u.is(":visible")){u.show();const n=e;var r=$("div."+n);setTimeout(function(){r.hide();r.remove()},500)}n.__trigger("clicked",{ctrlId:i.attr("id"),coord:getElementCoord(n.planfieldElement,t)})}}else if(n.isEditMode){const i=window.toolbox;i.recentItem&&n.createControlWithEv(i.recentItem,t)}});this.planfieldElement.get(0).ondragover=t=>{n.isEditMode&&t.preventDefault()};this.planfieldElement.get(0).ondrop=t=>{this.isEditMode&&n.createControlOnDrop(t,{editMode:!0})};$(document).keyup(function(t){t.keyCode===27&&n.clearCtrlSelection()})}__initBlockDrop(n){if(typeof n!="undefined"&&n!==null){const r=this,i=n.find("img");let t;const u=i.length;for(t=0;t<u;++t)$(i[t]).droppable({accept:"div.locomotiveInfo"});n.get(0).ondragover=function(n){n.preventDefault()};n.get(0).ondrop=function(t){try{t.preventDefault();const f=t.dataTransfer.getData("text"),i=JSON.parse(f),e={mode:"assignToBlock",oid:i.recid,coord:getThemeJsonData(n).coord};r.__trigger("assignToBlock",e);const u=w2ui[i.sourceGrid];u.selectNone();u.unselect(i.recid)}catch(t){}}}}updateFeedbacks(n){const r=this,u=n.data.length,t=$("div.ctrlItemBlock");if((r.__removeAllDisabledFlags(t),u!==0)&&typeof t!="undefined"&&t!=null&&t.length!==0){let i=0;for(;i<u;++i){const u=n.data[i];if(typeof u!="undefined"&&u!=null)try{const n=u.Settings.BlockEnabled;if(typeof n=="undefined"||n==null||n===!0)continue;const i=r.__getBlockCtrlOf(u,t);if(i==null)continue;i.addClass("blockDisabledState")}catch(f){}}}}__getBlockCtrlOf(n,t){const i=n.BlockId;for(let i=0;i<t.length;++i){const r=$(t[i]),u=r.data(constDataThemeItemObject),f=u.identifier;if(n.BlockId.startsWith(f))return r}return null}__removeAllDisabledFlags(n){if(typeof n!="undefined"&&n!=null&&n.length!==0){let t=0;const i=n.length;for(;t<i;++t){const i=n[t];typeof i!="undefined"&&i!=null&&$(i).removeClass("blockDisabledState")}}}updateEcosFeedbacks(n){const t=this,f=n.length,e=$("div.ctrlItemFeedback"),i=[];let r=0;const u=t.__recentFeedbacksData;(typeof u=="undefined"||u==null)&&(t.__recentFeedbacksData=n);for(let u=0;u<f;++u){const f=n[u];if(typeof f!="undefined"&&f!=null&&(f!==t.__recentFeedbacksData[u]||t.__firstRun!==!1)){for(let n=15;n>=0;--n){const l=r+n+1,u=getFbByEcosAddr(e,l);if(typeof u!="undefined"&&u!==null){let o="";const a=1<<n;o=(f.stateOriginal&a)!=0?"-on":"-off";const s=u.planItem.find("img");if(s){const h=s.attr("src"),v=h.includes("-route"),y=getDirpathOf(h);let t=u.themeData.basename;t=t.replace("-on","");t=t.replace("-off","");v===!0&&(o+="-route");const c=y+t+o+".png";h!==c&&i.push({ctrl:s,src:c+"?r="+Math.random()})}}}r+=f.ports}}for(let n=0;n<i.length;++n)i[n].ctrl.attr("src",i[n].src);t.__firstRun=!1}updateEcosAccessories(n){var i,t;const f=this;let r=n.length,u=$("div.ctrlItemAccessory");for(i=0;i<r;++i){const e=n[i];if(typeof e!="undefined"&&e!=null&&e.hasChanged){const f=getAccByEcosAddr(u,e.addr);if(f!=null){let s=0;if(f.ecosAddresses[0].ecosAddrValid===!0&&s++,f.ecosAddresses[1].ecosAddrValid===!0&&s++,s!==0){const o=f.planItem.find("img");if(o){const l=o.attr("src"),c=getDirpathOf(l),h=f.themeData.editor.themeId;let r=f.themeData.basename;switch(s){case 1:{let n=!1;f.ecosAddresses[0].ecosAddrValid===!0?n=f.ecosAddresses[0].inverse:f.ecosAddresses[1].ecosAddrValid===!0&&(n=f.ecosAddresses[1].inverse);t=e.state===1;n===!0&&(t=!t);isDecoupler(h)?t===!1?r+="-on":t===!0&&(r+=""):isSignal(h)?(r=r.replace("-r",""),r=r.replace("-g",""),t===!1?r+="-g":t===!0&&(r+="-r")):isAccessory(h)?t===!1?r+="-on":t===!0&&(r+="-off"):isSwitchOrAccessory(h)&&(t===!1||t===!0&&(r+="-t"));let i=o.attr("src"),u=!1,s=!1;u=i.includes("-occ");s=i.includes("-route");u?r+="-occ":s&&(r+="-route");r+=".png";o.get(0).src=c+r+"?t="+Math.random()}break;case 2:{const h=f.planItem,u=f.ecosAddresses,l=u[0].ecosAddr,a=u[1].ecosAddr,s=e.addr;let n=h.data("recentState");typeof n=="undefined"&&(n={},n[l]="straight",n[a]="straight");e.state===0?n[s]="straight":e.state===1&&(n[s]="turn");let t=n[l],i=n[a];const y=n;h.data("recentState",y);u[0].ecosAddr===s&&(u[0].inverse===!0&&(t==="turn"?t="straight":t==="straight"&&(t="turn")),n[s]=t);u[1].ecosAddr===s&&(u[1].inverse===!0&&(i==="turn"?i="straight":i==="straight"&&(i="turn")),n[s]=i);t==="straight"&&i==="straight"||(t==="turn"&&i==="turn"?r+="-t":t==="turn"&&i==="straight"?r+="-tl":t==="straight"&&i==="turn"&&(r+="-tr"));const v=o.attr("src"),p=v.includes("-occ"),w=v.includes("-route");p?r+="-occ":w&&(r+="-route");r+=".png";o.get(0).src=c+r+"?t="+Math.random()}}}}}}}}applyAddressToAccessory(n,t){if(typeof n!="undefined"&&n!=null&&typeof t!="undefined"&&t!=null){const i=$('div.ctrlItemAccessory[id="'+n+'"]');if(typeof i!="undefined"&&i!=null&&i.length!==0){const r=$(i[0]),u=r.data(constDataThemeItemObject);u.addresses=t;r.data(constDataThemeItemObject,u)}}}createControlOnDrop(n,t={}){const i=this;if(n.preventDefault(),n.dataTransfer){const i=n.dataTransfer.getData("text/plain"),r=JSON.parse(i);this.createControlWithEv(r,n,t)}}createControlWithEv(n,t,i={}){const u=this,r=getElementCoord(u.planfieldElement,t);if(n!=null&&typeof n.editor!="undefined"){const t=n.editor,i=parseInt(t.offsetX/constItemWidth),u=parseInt(t.offsetY/constItemHeight);r.x-=i;r.y-=u}this.createControl(n,r,i)}createControl(n,t,i={}){var d,y,s,p,h,f,r,c,l,e,b,tt,a,k,it;const u=this;if((d=$("div.ctrlItem[id]"),y=getCtrlOfCoord(t.x,t.y,d),typeof y=="undefined"||y==null)&&n!=null){s=coord2pixel(t);typeof i.editMode=="undefined"&&(i.editMode=!0);p=JSON.stringify(n);p=window.btoa(p);h=n.dimensions;typeof h=="undefined"&&(h=[{w:1,h:1}]);const g=h[0].w*constItemWidth,nt=h[0].h*constItemHeight;if(typeof n.editor=="undefined"&&(n.editor={}),typeof n.editor.themeDimIdx=="undefined"&&(n.editor.themeDimIdx=0),f="",typeof n.identifier!="undefined"&&this.__isInitialization?(f=n.identifier,f.length===0&&(f=this.generateUniqueItemIdentifier(n.editor.themeId))):f=this.generateUniqueItemIdentifier(n.editor.themeId),r=null,n.editor.themeId===1010){var w=null,v=null,o=null;n.editor.innerHtml&&(w=n.editor.innerHtml);n.editor.outerHtml&&(v=$(n.editor.outerHtml).css("font-size"));n.editor.size&&(o=n.editor.size);c=new TextfieldElement;c.install({fontSize:v,uniqueId:n.identifier});window.textfieldElementInstances.push(c);r=c.__element;r.addClass("ctrlItem");r.attr("draggable",!0);r.css({left:s.x+"px",top:s.y+"px",width:g+"px",height:nt+"px","z-index":0});r.data(constDataThemeItemObject,n);r.data(constDataThemeDimensionIndex,n.editor.themeDimIdx);l=r.find(".elEditor");n.editor.innerHtml&&w!==null&&l.html(w);n.editor.outerHtml&&v!==null&&l.css("font-size",v);n.editor.size&&o!==null&&(l.css({width:o.width,height:o.height}),l.parent().css({width:o.width,height:o.height}));this.__isInitialization||c.setEditMode(!0)}else r=$("<div>").addClass("ctrlItem").attr("id",f).css({left:s.x+"px",top:s.y+"px",width:g+"px",height:nt+"px"}),r.data(constDataThemeItemObject,n),r.data(constDataThemeDimensionIndex,n.editor.themeDimIdx),e=n.editor.themeId,isBlock(e)?r.addClass("ctrlItemBlock"):isSwitchOrAccessory(e)||isAccessory(e)||isSignal(e)||isDecoupler(e)?r.addClass("ctrlItemAccessory"):isFeedback(e)&&r.addClass("ctrlItemFeedback"),b="",b=n.active&&n.active.default?n.active.default+".png":n.basename+".png",tt=$("<img>",{}).attr({src:"theme/"+window.settings.themeName+"/"+b}),tt.appendTo(r),a=getLabelOffsetBy(n),a!==null&&(a.display="none",window.labelShown===!0&&(a.display="visible"),k=$("<div>",{}).css(a).html(f),k.addClass("elementLabel"),k.appendTo(r));r!==null&&(isBlock(n.editor.themeId)&&this.__initBlockDrop(r),r.appendTo(this.planfieldElement),r.click(function(){const n=$(this).hasClass("elEditorRoot");n||u.isEditMode&&(u.currentSelectionMoved||(u.isCtrlSelected(r)?u.unselectCtrl(r):(u.clearCtrlSelection(),u.selectCtrl(r))))}),r.mouseover(function(n){const i=$(this).data(constDataThemeItemObject);var t=i.coord;t||(t=getElementCoord(u.planfieldElement,n));const r=$(this).attr("id"),f=i.name+" ("+t.x+", "+t.y+") &mdash; "+r,e=$("#statusBar div.ctrlInfo");e.html(f)}),r.mouseleave(function(){const n=$("#statusBar div.ctrlInfo");n.html("")}),this.isEditMode&&this.initDragFor(r),i.editMode&&(it=r.hasClass("elEditorRoot"),it||this.selectCtrl(r)),this.editMenubar.setCurrentSelection(r),this.editMenubar.rot(-1,r,this.__isInitialization),this.__trigger("controlCreated",{instance:r}),this.__isInitialization||window.serverHandling.sendControl(r))}}removeDragFor(n){if(n!==null){const t=n.get(0);t.ondragstart=null}}initDragFor(n){function f(n){if(t.isEditMode){n=n||window.event;n.preventDefault();n.stopPropagation();t.currentSelectionMoved=!1;t.currentSelectionMovedItem=null;const h=$(this).hasClass("elEditorRoot");if(h){const n=$(this);t.currentSelectionMoved=!0;t.currentSelectionMovedItem=n;t.selectCtrl(n,{startEditMode:!1})}else{const i=$(n.target).parent();t.currentSelectionMoved=!0;t.currentSelectionMovedItem=i;t.selectCtrl(i)}document.onmouseup=o;document.onmousemove=e;const r=getElementCoord(u,n),f=$(n.target).parent(),s={x:Math.floor(f.get(0).offsetLeft/constItemWidth),y:Math.floor(f.get(0).offsetTop/constItemHeight)};i={x:Math.floor(r.x-s.x),y:Math.floor(r.y-s.y)}}}function e(n){if(t.isEditMode){n=n||window.event;n.preventDefault();n.stopPropagation();const f=getElementCoord(u,n);var e=(f.y-i.y)*constItemHeight,o=(f.x-i.x)*constItemWidth;const s=t.currentSelection.hasClass("elEditorRoot");s&&(e=Math.floor(f.y*constItemHeight),o=Math.floor(f.x*constItemWidth));r.style.top=e+"px";r.style.left=o+"px";s||t.editMenubar.updateEditMenuPositionAndEvents(t.currentSelection)}}function o(){t.isEditMode&&(document.onmouseup=null,document.onmousemove=null,t.__isInitialization||(window.serverHandling.removeControl(t.currentSelectionMovedItem.attr("id")),window.serverHandling.sendControl(t.currentSelectionMovedItem)),t.currentSelectionMovedItem=null)}var r=n.get(0),u,i;r.ondragstart=f;u=n.parent();const t=this;i=null}highlightAccessory(n,t){const r=this,u=n,i=$("div.ctrlItem[id]");for(let r=0;r<i.length;++r){const u=i[r];if(u){const f=$(u).data(constDataThemeItemObject);if(f!=null&&f.identifier===n){t?$(u).addClass("highlightAccessory"):$(u).removeClass("highlightAccessory");return}}}}initFromServer(n){const t=n.planField;this.__isInitialization=!0;for(let n in t)if(t.hasOwnProperty(n)){const i=t[n];this.createControl(i,i.coord,{editMode:!1})}this.__isInitialization=!1}}class Routes{constructor(){console.log("**** construct Routes");this.__installed=!1;this.__gridName="gridRoutes";this.__dialogName="dialogRoutes";this.__storageNameGeometry=this.__dialogName+"_geometry";this.__windowGeometry=new WindowGeometryStorage(this.__dialogName);this.__initEventHandling()}__initEventHandling(){this.__events=new Events}on(n,t){this.__events.on(n,t)}__trigger(n,t){this.__events.triggerHandler(n,{sender:this,data:t})}show(){const n=$("#"+this.__dialogName);this.__windowGeometry.showWithGeometry(n);this.__installed?n.dialog("open"):(this.install({autoOpen:!0}),n.dialog("open"));w2ui[this.__gridName].refresh()}isShown(){try{return $("#"+this.__dialogName).dialog("isOpen")}catch(n){}return!1}__removeAllHighlights(){const n=window.planField;n&&n.clearRouteUserHighlight()}install(n={}){const t=this,r=this.isShown();if(!r){typeof n.autoOpen=="undefined"&&(n.autoOpen=!1);const i=this.__windowGeometry.recent();if($("#"+this.__dialogName).dialog({height:i.height,width:i.width,left:i.left,top:i.top,autoOpen:n.autoOpen,resizeStop:function(n,i){t.__windowGeometry.save(i.position,i.size)},dragStop:function(n,i){t.__windowGeometry.save(i.position,{width:n.target.clientWidth,height:n.target.clientHeight})},close:function(){t.__removeAllHighlights();const n=w2ui[t.__gridName];n.selectNone()}}),!w2ui[this.__gridName]){const i=$("#"+this.__gridName);i.w2grid({name:this.__gridName,header:"Routes",multiSelect:!1,show:{toolbar:!0,footer:!0,toolbarAdd:!1,toolbarDelete:!1,toolbarEdit:!1,toolbarSave:!1,multiSelect:!1},textSearch:"contains",recid:"routeId",searches:[{field:"name",caption:"Name",type:"text"}],sortData:[{field:"routeId",direction:"asc"}],columns:[{field:"routeId",caption:"Route ID",sortable:!1,hidden:!0},{field:"native",caption:"Native",sortable:!0,hidden:!0},{field:"name",caption:"Name",size:"20%",sortable:!0},{field:"isDisabled",caption:"Disabled",size:"10%",style:"text-align: center",editable:{type:"checkbox",style:"text-align: center"}},{field:"switches",caption:"Switches",size:"10%",sortable:!1},{field:"sensors",caption:"Sensors",size:"10%",sortable:!1},{field:"signals",caption:"Signals",size:"10%",sortable:!1},{field:"tracks",caption:"Tracks",size:"10%",sortable:!1},],records:[],onSelect:function(n){const r=w2ui[t.__gridName],u=r.get(n.recid),i=window.planField;i&&(i.clearRouteUserHighlight(),i.activateRouteUserHighlight(u.native))},onUnselect:function(){t.__removeAllHighlights()}});const n=w2ui[t.__gridName].toolbar;n&&(n.insert("search",{type:"button",id:"itemCheckRoute",text:"Check",img:"fas fa-check",checked:!1,tooltip:function(){return"Simulates the route by changing any relevant accessory to let the trains reach its destination."},onClick:function(){const n=w2ui[t.__gridName],i=n.getSelection();for(let r=0;r<i.length;++r){const f=i[r],u=n.get(f);t.__trigger("checkRoute",{mode:"checkRoute",routeName:u.name,"native":u.native})}}}),n.add({type:"button",id:"cmdSave",text:"Save ",img:"fas fa-save",tooltip:function(){return"Applies all changes to the server."},onClick:function(){const n=w2ui[t.__gridName],i=n.getChanges();for(let r=0;r<i.length;++r){const e=i[r],o=e.recid,f=n.get(o),u=e.isDisabled;typeof u!="undefined"&&u!=null&&(f.isDisabled=u,n.refreshCell(f,"isDisabled"),t.__trigger("setting",{mode:"route",cmd:"disable",value:{routeName:f.name,disableState:u}}))}t.__cleanupChangedState()}}));this.__installed=!0}}}__cleanupChangedState(){const n=this;$("#"+this.__dialogName+" td.w2ui-grid-data").each(function(){$(this).removeClass("w2ui-changed")})}updateRoutes(n){const u=this;if(typeof n!="undefined"&&n!=null){const i=w2ui[u.__gridName],r=[];let t;const f=n.length;for(t=0;t<f;++t){const e=i.find({routeId:t}),u=n[t],o=u.name;let f=u.isDisabled;if((typeof f=="undefined"||f==null)&&(f=!1),e.length<=0)r.push({routeId:t,"native":u,name:o,isDisabled:f,switches:u.switches.length,sensors:u.sensors.length,signals:u.signals.length,tracks:u.tracks.length});else{const r=e[0],n=i.get(r);n.isDisabled!==f&&(n.isDisabled=f,i.refreshCell(t,"isDisabled"))}}r.length>0&&i.add(r)}}clearGrid(){const t=this;typeof routes!="undefined"&&window.routes!=null&&(window.routes=[]);const n=w2ui[t.__gridName];typeof n!="undefined"&&n!=null&&(n.clear(!0),n.reset())}}class ServerHandling{constructor(n={}){console.log("**** construct ServerHandling");this.__reconnectIntervalMsecs=5e3;this.__updateServerInformation(n);this.__planField=window.planField;this.__errorHandler=window.errorHandler;this.__checkConnectIntervalId=null;this.__initEventHandling()}__initEventHandling(){this.__events=new Events}on(n,t){this.__events.on(n,t)}__trigger(n,t){this.__events.triggerHandler(n,{sender:this,data:t})}__getReconnectCountdownMessage(n){return"Connection not established to "+this.wsUrl+". Try to reconnect in "+n+" seconds."}__updateServerInformation(n){n&&(n.wsAddr&&(this.wsAddr=n.wsAddr),n.wsPort&&(this.wsPort=n.wsPort))}__cleanupWebSocket(){(typeof self.__ws!="undefined"||self.__ws!=null)&&(this.__ws.onopen=function(){},this.__ws.onmessage=function(){},this.__ws.onerror=function(){},this.__ws.onclose=function(){},this.__ws.close())}__connect(){const n=this;this.__cleanupWebSocket();this.wsUrl="ws://"+this.wsAddr+":"+this.wsPort+"/";this.__ws=new WebSocket(this.wsUrl);this.__ws.onopen=function(){n.__handleOnOpen()};this.__ws.onmessage=function(t){n.__handleOnMessage(t)};this.__ws.onerror=function(t){n.__handleOnError(t)};this.__ws.onclose=function(){n.__handleOnClose()}}__startConnectHandlerInterval(){if(this.__checkConnectIntervalId==null){const n=this;var t=parseInt(this.__reconnectIntervalMsecs/1e3);this.__checkConnectIntervalId=setInterval(function(){t<=0?(console.log("Try to connect..."),n.__errorHandler.setLevel(ErrorHandlerLevel.Info),n.__errorHandler.setText("Try to connect...",!0),n.__stopConnectHandlerInterval(),n.__connect()):(n.__errorHandler.setLevel(ErrorHandlerLevel.Error),n.__errorHandler.setText(n.__getReconnectCountdownMessage(t),!0));--t},1e3)}}__stopConnectHandlerInterval(){if(this.__checkConnectIntervalId!=null){const n=this;clearInterval(this.__checkConnectIntervalId);this.__checkConnectIntervalId=null}}__handleOnOpen(){console.log("ServerHandling Connected to "+this.wsUrl);this.__stopConnectHandlerInterval();this.__errorHandler.hide()}__handleOnMessage(n){const t=JSON.parse(n.data);switch(t.command){case"debugMessages":this.__trigger("debugMessages",t.messages);break;case"initialization":this.__trigger("settingsDataReceived",t.settings);this.__trigger("themeDataReceived",t.themeData);this.__planField.initFromServer(t.metamodel);this.__trigger("dataReceived",t);break;case"update":this.__trigger("dataReceived",t);break;case"occ":this.__trigger("occReceived",t);break;case"locomotivesData":this.__trigger("locomotivesDataReceived",t);break;case"feedbacksData":this.__trigger("feedbacksDataReceived",t);break;case"autoMode":this.__trigger("autoModeReceived",t);break;case"result":this.__trigger("commandResultReceived",t)}}__handleOnError(){const n=this.__reconnectIntervalMsecs/1e3;this.__errorHandler.setLevel(ErrorHandlerLevel.Error);this.__errorHandler.setText(this.__getReconnectCountdownMessage(n));this.__cleanupWebSocket();this.__startConnectHandlerInterval()}__handleOnClose(){this.__errorHandler.setLevel(ErrorHandlerLevel.Error);this.__errorHandler.setText("Connection closed.");this.__cleanupWebSocket();this.__startConnectHandlerInterval()}establishConnection(n={}){const t=this;this.__errorHandler.setLevel(ErrorHandlerLevel.Info);this.__errorHandler.setText("Try to establish connection...");this.__updateServerInformation(n);this.__connect()}isConnected(){if(typeof this.__ws=="undefined"||this.__ws==null)return!1;var n=this.__ws.readyState;return n==1}__getCoordOf(n){const t=n.get(0).offsetLeft/constItemWidth,i=n.get(0).offsetTop/constItemHeight;return{x:t,y:i}}__getJsonData(n){return n.data(constDataThemeItemObject)}sendControl(n){var t,r,i,u;if(!this.isConnected())return!1;t={command:"update",itemData:this.__getJsonData(n)};t.itemData.identifier=n.attr("id");t.itemData.coord=this.__getCoordOf(n);t.itemData.editor.themeDimIdx=n.data(constDataThemeDimensionIndex);r=n.hasClass("elEditorRoot");r&&(i=n.find("div.elEditor"),t.itemData.editor.innerHtml=i.html(),t.itemData.editor.outerHtml=n.html(),t.itemData.editor.size={width:i.css("width"),height:i.css("height")});u=JSON.stringify(t);this.__ws.send(u)}removeControl(n){if(!this.isConnected())return!1;var t={command:"remove",itemId:n};this.__ws.send(JSON.stringify(t))}sendCommand(n){typeof n!="undefined"&&n!==null&&this.__ws.send(JSON.stringify(n))}}(function(n,t){"use strict";var i=[];t.each(["localStorage","sessionStorage"],function(r,u){try{i[u]=u in n&&n[u]!==null}catch(f){i[u]=!1}t[u]={settings:{cookiePrefix:"ecosApp:"+u+":",cookieOptions:{path:"/ecosApp",domain:document.domain,expires:"localStorage"===u?{expires:365}:undefined}},getItem:function(r){return i[u]?n[u].getItem(r):t.cookie(this.settings.cookiePrefix+r)},setItem:function(r,f){return i[u]?n[u].setItem(r,f):t.cookie(this.settings.cookiePrefix+r,f,this.settings.cookieOptions)},removeItem:function(r){if(i[u])return n[u].removeItem(r);var f=t.extend(this.settings.cookieOptions,{expires:-1});return t.cookie(this.settings.cookiePrefix+r,null,f)},clear:function(){if(i[u])return n[u].clear();var r=new RegExp("^"+this.settings.cookiePrefix,""),f=t.extend(this.settings.cookieOptions,{expires:-1});document.cookie&&document.cookie!==""&&t.each(document.cookie.split(";"),function(n,i){r.test(i=t.trim(i))&&t.cookie(i.substr(0,i.indexOf("=")),null,f)})}}})})(window,jQuery);class TextfieldElement{constructor(){console.log("**** construct TextfieldElement");window.__currentTextEditorElement=null;this.__tbId="textfieldElementToolbar";this.__uniqueId=null;this.__element=null;this.__initialText="TEXT";this.__initialFontSize="14px"}setEditMode(n){n?this.__element.resizable("enable"):(this.__element.attr("contenteditable",!1),this.__element.resizable("disable"))}install(n={}){typeof n.fontSize!="undefined"&&(this.__initialFontSize=n.fontSize);this.__uniqueId=typeof n.uniqueId!="undefined"?n.uniqueId:null;this.__initEditorToolbar();var i=$(".tplElEditorRoot"),t=i.clone();t.removeClass("tplElEditorRoot");t.addClass("elEditorRoot");this.__element=t;this.__uniqueId==null&&(this.__uniqueId=window.planField.generateUniqueItemIdentifier());t.attr("id",this.__uniqueId);t.show();this.__element.resizable({grid:constItemWidth});this.__initEditorForTextElements();this.__alignToolbarToEditor(t);this.setEditMode(!1)}__initEditorToolbar(){const n=this;this.__selectedSizeIdx="idSize14";switch(this.__initialFontSize){case"10px":this.__selectedSizeIdx="idSize10";break;case"11px":this.__selectedSizeIdx="idSize11";break;case"12px":this.__selectedSizeIdx="idSize12";break;case"13px":this.__selectedSizeIdx="idSize13";break;case"14px":this.__selectedSizeIdx="idSize14";break;case"15px":this.__selectedSizeIdx="idSize15";break;case"16px":this.__selectedSizeIdx="idSize16"}(typeof __editorToolboxInitialized=="undefined"&&(window.__editorToolboxInitialized=!1),window.__editorToolboxInitialized)||(window.__editorToolboxInitialized=!0,$("#"+this.__tbId).w2toolbar({name:"toolbarFont",style:"position: absolute; display: none;",items:[{id:"cmdRemove",type:"button",icon:"fas fa-trash-alt"},{type:"break"},{id:"cmdBold",type:"button",icon:"fas fa-bold"},{id:"cmdItalic",type:"button",icon:"fas fa-italic"},{id:"cmdUnderline",type:"button",icon:"fas fa-underline"},{type:"menu-radio",id:"fontSize",text:function(n){var t=this.get("fontSize:"+n.selected);return t.text},selected:n.__selectedSizeIdx,items:[{id:"idSize10",text:"10px"},{id:"idSize11",text:"11px"},{id:"idSize12",text:"12px"},{id:"idSize13",text:"13px"},{id:"idSize14",text:"14px"},{id:"idSize15",text:"15px"},{id:"idSize16",text:"16px"}]},{id:"cmdBackgroundColor",type:"color"},{id:"cmdTextColor",type:"text-color",transparent:!1}],onClick:function(t){var r,i,u;if(t.color!=null)t.done(function(){if(window.__currentTextEditorElement!=null)switch(t.item.type){case"color":document.execCommand("hilitecolor",!1,t.item.color);break;case"text-color":document.execCommand("foreColor",!1,t.item.color)}});else if(t.object!==null&&typeof t.object!="undefined")switch(t.object.id){case"cmdRemove":i=window.__currentTextEditorElement;i.off("DOMSubtreeModified");i.find(".elEditor").off("DOMSubtreeModified");$("#"+n.__tbId).hide();r=i.attr("id");window.serverHandling.removeControl(r);i.remove();removeTextfieldFromGlobalList(r);break;case"cmdBold":document.execCommand("bold",!1,null);break;case"cmdItalic":document.execCommand("italic",!1,null);break;case"cmdUnderline":document.execCommand("underline",!1,null)}else t.item!==null&&typeof t.item!="undefined"&&(i=window.__currentTextEditorElement,u=w2ui.toolbarFont.get(t.target).text,i.find(".elEditor").css({"font-size":u}),window.serverHandling.sendControl(i))}}))}__initEditorForTextElements(){var i;const n=this;this.setEditMode(window.planField.isEditMode);var t=this.__element,r=function(n){var t,r,i;if(typeof n.target!="undefined"&&n.target!==null){if(t=n.currentTarget,t&&$(t).hasClass("elEditorRoot")){window.serverHandling.sendControl($(t));return}r=$(n.target);i=r.parent(".elEditorRoot");i&&window.serverHandling.sendControl(i)}},u=function(n,t){if(t)n.on("DOMSubtreeModified",r);else n.off("DOMSubtreeModified",r)};t.dblclick(function(){if(window.planField.isEditMode){n.__element.attr("contenteditable",!0);$(this).focus();u($(this),!0);var t=$("#"+n.__tbId);t.show();n.__alignToolbarToEditor(n.__element);window.__currentTextEditorElement=$(this);w2ui.toolbarFont.refresh();$("#"+n.__tbId).find(".w2ui-scroll-right").css("display","none");$("#tb_toolbarFont_right").css("display","none")}});t.keydown(function(t){if(!t.shiftKey&&(t.keyCode===constKeyEnter||t.keyCode===constKeyEscape)){t.stopPropagation();t.preventDefault();$("#"+n.__tbId).hide();var i=$(".elEditorRoot");i.each(function(){$(this).blur();u($(this).find(".elEditor"),!1);$(this).attr("contenteditable",!1)})}});t.resize(function(){var i=$(this).width(),r=$(this).height(),t;n.__element.find(".elEditor").css({width:i+"px",height:r+"px"});t=window.__currentTextEditorElement;t||(t=n.__element);window.serverHandling.sendControl(t)});i=t.find(".elEditor");i.css({"font-size":this.__initialFontSize});i.html(this.__initialText)}__alignToolbarToEditor(n){var r;if(n){var i=n.get(0).getBoundingClientRect(),u=i.left,f=i.top,e=$("#"+this.__tbId).get(0).getBoundingClientRect(),o=e.height,s=w2ui.toolbarFont.items.length,h=s*constItemWidth+2+"px",t=f-o-5;t<0&&(t=0);r=$("#"+this.__tbId);r.css({"z-index":999,left:u-constItemWidth-5+"px",top:t+"px",width:h,border:"1px solid rgba(0,0,0,0.2)"})}}}class Toolbox{constructor(){toolbox;console.log("**** construct Toolbox");this.__toolbox=$("#toolbox");this.recentItem=null}rotate(n){const t=$("div.toolboxItem").filterByData("theme-id",n.themeId);if(typeof t!="undefined"&&t!=null){const i=t.find("img");if(typeof i!="undefined"&&i!=null){t.data(constDataThemeDimensionIndex,n.themeDimIdx);i.css({"transform-origin":n.transformOrigin,transform:n.transform});const r=this.getJsonDataOfItem(t);t.data(constDataThemeItemObject,r);this.recentItem=r}}}getJsonDataOfItem(n){const t=n.data(constDataThemeItemObject);return typeof t.editor=="undefined"&&(t.editor={}),t.editor.themeId=n.data("theme-id"),t.editor.themeDimIdx=n.data(constDataThemeDimensionIndex),t}showToolbox(){this.__toolbox.show()}hideToolbox(){this.__toolbox.hide()}__collapseCategory(n){n.data("railway-collapsed","");n.parent().find("div.toolboxItem").each(function(){$(this).hide()});const t=n.find("img");t.attr("src","images/expand.png")}__expandCategory(n){n.removeData("railway-collapsed");n.parent().find("div.toolboxItem").each(function(){$(this).show()});const t=n.find("img");t.attr("src","images/collapse.png")}install(){function i(t){const r=$(t.target),i=n.getJsonDataOfItem(r);i.editor.offsetX=t.offsetX;i.editor.offsetY=t.offsetY;r.data(constDataThemeItemObject,i);const u=JSON.stringify(i);t.dataTransfer.setData("text/plain",u);n.recentItem=i}const n=this;themeObject.forEach(t=>{var u=$("<div>",{}).css({}).addClass("toolboxHead").appendTo(this.__toolbox),i=$("<div>",{text:t.category}).addClass("toolboxTitle"),f,r;i.click(function(){var t=i.data("railway-collapsed");t=typeof t=="undefined"&&t==null?!1:!0;t?n.__expandCategory(i):n.__collapseCategory(i)});f=$("<img>",{width:"16px",height:"16px",float:"right"});f.appendTo(i);i.appendTo(u);r=$("<div>").appendTo(u);r.addClass("toolboxContainer");t.objects.forEach(n=>{if(n.id!=-1){if(typeof n.visible!="undefined"&&n.visible===!1)return;const t=$("<div>",{html:""}).addClass("toolboxItem").attr({draggable:"true"});t.data(constDataThemeId,n.id);t.data(constDataThemeItemObject,n);t.appendTo(r);let i="";i=n.active&&n.active.default?n.active.default+".png":n.basename+".png";const u=$("<img>",{}).addClass("imgWithTooltip").attr({"data-tipso-title":n.name,draggable:"false",src:"theme/"+window.settings.themeName+"/"+i});u.appendTo(t)}});t.category==="Signal"||t.category==="Block"?this.__collapseCategory(i):this.__expandCategory(i)});const t=$("div.toolboxItem");for(let n=0;n<t.length;++n){const r=t[n];r.ondragstart=i}$(".imgWithTooltip").tipso({size:"tiny",speed:100,delay:500,useTitle:!0,width:"auto",background:"#333333",titleBackground:"#333333"});this.__toolbox.resizable({minWidth:125,autoHide:!0})}}_htmlEntities=function(n){return String(n).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;")};window.__cachedLocomotiveImages={};class WindowGeometryStorage{constructor(n,t={left:100,top:100,width:450,height:500}){this.__fieldName=n;this.__defaultGeometry=t}save(n,t){const r=this;var i={left:n.left,top:n.top,width:t.width,height:t.height};$.localStorage.setItem(this.__fieldName,JSON.stringify(i))}recent(){var n;const t=this;return(n=$.localStorage.getItem(this.__fieldName),typeof n=="undefined"||n==null)?this.__defaultGeometry:JSON.parse(n)}showWithGeometry(n,t=true){var i=this.recent();t===!0&&(n.dialog("option","height",i.height),n.dialog("option","width",i.width));n.dialog("option","position",{my:"left top",at:"left+"+i.left+" top+"+i.top,of:window})}}window.__trainEvents||(window.__trainEvents=new Events,window.__eventOn=function(n,t){this.__trainEvents.on(n,t)},window.__eventTrigger=function(n,t){this.__trainEvents.triggerHandler(n,{sender:this,data:t})});window.occ=null;window.blocks=null;window.ecosData=null;window.serverHandling=null;window.editState=!1;window.routesDlg=null;window.accessoriesDlg=null;window.locomotivesDlg=null;window.locomotiveCtrlDlgs=[];window.textfieldElementInstances=[];window.planField=null;window.toolbox=null;window.errorHandler=null;window.labelShown=!1;window.findLocomotivesDlg=function(n){var r,t,i;if(!n)return null;for(r=window.locomotiveCtrlDlgs.length,t=0;t<r;++t)if((i=window.locomotiveCtrlDlgs[t],i)&&i.__dlgId===n)return i;return null};$(document).ready(function(){function n(n){return typeof n=="undefined"||n==null?!1:(window.planField.updateEcosAccessories(window.ecosData.accessories),typeof accessoriesDlg=="undefined"||window.accessoriesDlg==null)?!1:(n.result===!0&&(window.accessoriesDlg.removeAccessory(n.identifier),window.blocksDlg.controlRemoved(n.identifier)),!0)}window.__autoModeState=!1;loadWebcams();addJqueryExtensions();initDebugConsole();$("#statusBar div.autoMode").tipso({size:"tiny",speed:100,delay:250,useTitle:!0,background:"#333333",titleBackground:"#333333"});$("#statusBar div.logging").tipso({size:"tiny",speed:100,delay:250,useTitle:!0,background:"#333333",titleBackground:"#333333"});window.__ecosbaseChanged=!1;window.__locomotivesChanged=!1;window.__accessoriesChanged=!1;window.__feedbacksChanged=!1;window.errorHandler=new ErrorHandler;window.toolbox=new Toolbox;window.dialogLightAndPower=new LightAndPower;window.dialogLightAndPower.install();window.dialogLightAndPower.on("relayCommand",function(n){const t=n.data;t.mode==="websocket"?relayWebsocketCommand(t):console.log("TODO unknown relay mode: "+t.mode)});window.dialogS88=new FeedbackVisualization;window.dialogS88.install();window.blocksDlg=new Blocks;window.blocksDlg.install();window.blocksDlg.on("setting",function(n){changeSetting(n.data)});window.occ=new Occ;window.occ.on("gotoBlock",function(n){gotoBlock(n.data)});window.occ.on("resetAssignment",function(n){resetAssignment(n.data)});window.occ.on("speedChanged",function(n){changeLocomotive("speedstep",n.data)});window.occ.on("directionChanged",function(n){changeLocomotive("direction",n.data)});window.occ.on("openLocomotiveControl",function(n){const t=n.data.oid;openLocomotiveControlDialogByOid(t)});window.occ.on("setting",function(n){changeSetting(n.data)});window.accessoriesDlg=new Accessories;window.accessoriesDlg.install();window.accessoriesDlg.on("accessoryExecute",function(n){accessoryExecute(n.data)});window.accessoriesDlg.on("setting",function(n){changeSetting(n.data)});window.routesDlg=new Routes;window.routesDlg.install();window.routesDlg.on("checkRoute",function(n){checkRoute(n.data)});window.routesDlg.on("setting",function(n){changeSetting(n.data)});window.locomotivesDlg=new Locomotives;window.locomotivesDlg.install();window.locomotivesDlg.on("locomotiveDoubleClick",function(n){const t=n.data;openLocomotiveControlDialog(t)});window.locomotivesDlg.on("setting",function(n){changeSetting(n.data)});window.__eventOn("functionChanged",function(n){var t=JSON.parse(n.data);changeLocomotive("function",t)});window.planField=new Planfield({isEditMode:!1});window.planField.install();window.planField.on("controlCreated",function(n){const t=n.data.instance;typeof blocksDlg!="undefined"&&window.blocksDlg!=null&&window.blocksDlg.controlCreated(t)});window.planField.on("clicked",function(n){itemClicked(n.data)});window.planField.on("assignToBlock",function(n){assignLocomotiveToBlock(n.data)});window.serverHandling=new ServerHandling({wsAddr:"localhost",wsPort:45099});window.serverHandling.establishConnection();window.serverHandling.on("occReceived",function(n){window.occ.handleData(n.data);window.locomotivesDlg.updateOccInformation(n.data)});window.serverHandling.on("locomotivesDataReceived",function(n){window.locomotivesDlg.updateLocomotives2(n.data);window.occ.updateOccWithLocomotiveData(n.data)});window.serverHandling.on("feedbacksDataReceived",function(n){window.blocksDlg.updateFeedbacks(n.data);window.planField.updateFeedbacks(n.data);window.locomotivesDlg.updateBlockInformation(n.data)});window.serverHandling.on("settingsDataReceived",function(n){window.settings=n.data});window.serverHandling.on("themeDataReceived",function(n){window.themeObject=n.data;window.toolbox.install()});window.serverHandling.on("debugMessages",function(n){window.addDebugMessages(n.data)});window.serverHandling.on("commandResultReceived",function(t){const i=t.data;if(typeof i=="undefined"||i==null)return!1;const r=i.command,u=i.result;if(typeof r=="undefined"||r==null||typeof u=="undefined"||u==null)return!1;switch(r){case"result":return n(u)}return!1});window.serverHandling.on("dataReceived",function(n){var t,i,r;if(window.ecosData=n.data.ecosData,typeof ecosData!="undefined"&&window.ecosData!=null){if(window.__ecosbaseChanged=window.ecosData.ecosbaseChanged,window.__locomotivesChanged=window.ecosData.locomotivesChanged,window.__accessoriesChanged=window.ecosData.accessoriesChanged,window.__feedbacksChanged=window.ecosData.feedbacksChanged,window.__ecosbaseChanged===!0&&(t=window.ecosData.ecosbase[0],typeof t!="undefined"&&t!=null)){i=$("#statusBar div.ecosPowerStatus");t.status==="GO"?(i.removeClass("offline"),i.addClass("online")):(i.removeClass("online"),i.addClass("offline"));var u=$("#statusBar div.ecosInformation"),f=t.name,e=t.protocolVersion,o=t.applicationVersion,s=t.hardwareVersion,h="<b>"+f+"<\/b> (SW: "+o+", HW: "+s+", Protocol: "+e+")";u.html(h)}window.__locomotivesChanged===!0&&(r=window.ecosData.locomotives,typeof r!="undefined"&&(window.locomotivesDlg.updateLocomotives(r),window.locomotivesDlg.updateLocomotives2(r)))}typeof n.data.routes!="undefined"&&n.data.routes!=null&&(window.routes=n.data.routes,typeof routes=="undefined"||window.routes==null||window.routesDlg.updateRoutes(window.routes));window.accessoriesDlg&&window.accessoriesDlg.updateAccessories(n.data);typeof ecosData!="undefined"&&window.ecosData!==null&&(window.__accessoriesChanged===!0&&window.planField.updateEcosAccessories(window.ecosData.accessories),window.__feedbacksChanged===!0&&(window.planField.updateEcosFeedbacks(window.ecosData.feedbacks),window.dialogS88.updateFeedbackSensors(window.ecosData.feedbacks)),window.accessoriesDlg&&window.accessoriesDlg.updateStates(n.data),typeof window.ecosData.locomotives!="undefined"&&window.ecosData.locomotives!=null&&window.__locomotivesChanged===!0&&window.occ.loadLocomotives(window.ecosData.locomotives))});window.serverHandling.on("autoModeReceived",function(n){const t=n.data;if(typeof t=="undefined"||t==null)return!1;const i=t.command;if(typeof i=="undefined"||i==null)return!1;const r=t.data.command;switch(r){case"state":{let n=t.data.state;(typeof n=="undefined"||n==null)&&(n=!1);reinitAutoMode(n)}break;case"routeShow":{const n=t.data.routeNames;if(typeof n=="undefined"||n==null)return!1;let i;const r=n.length;for(i=0;i<r;++i)if(n[i]!=null){const t=n[i],r=getRouteByName(t);if(r==null){console.log("Route does not exist: "+t);continue}window.planField.activateRouteVisualization(r)}}break;case"routeReset":{const n=t.data.routeNames;if(typeof n=="undefined"||n==null)return!1;let i;const r=n.length;for(i=0;i<r;++i)if(n[i]!=null){const t=n[i],r=getRouteByName(t);if(r==null){console.log("Route does not exist: "+t);continue}window.planField.deativateRouteVisualization(r)}}}});loadSideBar()});loadSideBar=function(){function t(n,t=true,i=null){(typeof __autoModeState=="undefined"||window.__autoModeState==null)&&(window.__autoModeState=!1);let r;r=n===!0&&window.__autoModeState===!1?"Do you like to start AutoMode?":"Stop AutoMode?";w2confirm(r,"AutoMode").yes(function(){const n=window.serverHandling;typeof n!="undefined"&&n!=null&&(window.__autoModeState===!0?(window.planField.clearRouteUserHighlight(),t===!0&&n.sendCommand({command:"autoMode",timestamp:Date.now(),cmddata:{state:!1}}),$("#statusBar div.autoMode").removeClass("fa-spin"),window.__autoModeState=!1):window.__autoModeState===!1&&(t===!0&&n.sendCommand({command:"autoMode",timestamp:Date.now(),cmddata:{state:!0}}),$("#statusBar div.autoMode").addClass("fa-spin"),window.__autoModeState=!0),i!=null&&i(window.__autoModeState))}).no(function(){})}function i(){w2confirm("Do you like to initialize all Switches, Accessories, Signals, and more to a well known state?","Initialize").yes(function(){const n=window.serverHandling;typeof n!="undefined"&&n!=null&&n.sendCommand({command:"initializeSystem",timestamp:Date.now(),cmddata:{}})}).no(function(){})}function r(){w2confirm("Do you like to analyze all routes?<br><br>Current disabled states will be kept, new routes will be added, vanished routes will be removed.","Analyze Routes").yes(function(){const n=window.serverHandling;typeof n!="undefined"&&n!=null&&(window.routesDlg.clearGrid(),window.blocksDlg.clearGrid(),n.sendCommand({command:"analyzeRoutes",timestamp:Date.now(),cmddata:{}}))}).no(function(){})}function u(){w2confirm("Do you like to shutdown your model railway?","Shutdown").yes(function(){const n=window.serverHandling;typeof n!="undefined"&&n!=null&&n.sendCommand({command:"shutdownSystem",timestamp:Date.now(),cmddata:{}})}).no(function(){})}function n(n,t,i,r,u){if(typeof u!="undefined"&&u!=null)n.text=u===!0?t+" (on)":t+" (off)";else{const i=n.text,u=i.includes("off");u?(n.text=t+" (on)",typeof r!="undefined"&&r!=null&&r(!0)):(n.text=t+" (off)",typeof r!="undefined"&&r!=null&&r(!1))}w2ui.sidebar.refresh(i)}function f(){w2popup.open({title:"TODO / TBD",body:'<div class="w2ui-centered">Must be implemented.<\/div>'})}$("#sidebar").w2sidebar({name:"sidebar",flatButton:!0,nodes:[{id:"level-1",text:"Control",img:"icon-folder",expanded:!0,group:!0,groupShowHide:!1,nodes:[{id:"cmdOpenLocomotives",text:"Locomotives",icon:"fa fa-train"},{id:"cmdAccessories",text:"Accessories",icon:"fas fa-magic"},{id:"cmdLight",text:"Light",icon:"fas fa-lightbulb"},{id:"cmdInitialize",text:"Initialize",icon:"fas fa-tasks"},{id:"cmdAutomatic",text:"Automatic (off)",icon:"fas fa-robot fa-red"}]},{id:"level-2",text:"Administration",img:"icon-folder",expanded:!0,group:!0,groupShowHide:!0,nodes:[{id:"cmdToggleLabels",text:"Labels (off)",icon:"fas fa-tags"},{id:"cmdEditPlan",text:"Layout",icon:"fa fa-edit"},{id:"cmdOpenBlocksAndFeedbacks",text:"Blocks/S88/Signals",icon:"fas fa-traffic-light"},{id:"cmdOpenS88",text:"S88 Viewer",icon:"fas fa-radiation-alt"},{id:"cmdOpenRoutes",text:"Routes",icon:"fa fa-route"},{id:"cmdAnalyzeRoutes",text:"Analyze Routes",icon:"fas fa-diagnoses"},{id:"cmdToggleWebcams",text:"Webcams (on)",icon:"fas fa-video"},{id:"cmdWorldClock",text:"Worldclock",icon:"fas fa-history",hidden:!0}]},{id:"levelEcos",text:"ECoS",img:"icon-folder",expanded:!0,group:!0,groupShowHide:!1,nodes:[{id:"cmdPower",text:"Power",icon:"fas fa-power-off"},{id:"cmdStop",text:"Stop Trains",icon:"fas fa-stop-circle"},{id:"cmdShutdown",text:"Shutdown",icon:"fas fa-times-circle"},{id:"cmdChangeWorkspace",text:"Workspace",icon:"fas fa-code-branch"}]},{id:"level-3",text:"Help",img:"icon-folder",group:!0,groupShowHide:!0,nodes:[{id:"cmdHelp",text:"Help",icon:"fas fa-question-circle"},{id:"cmdAbout",text:"About",icon:"fas fa-address-card"}]}],onFlat:function(n){$("#sidebar").css("width",n.goFlat?"35px":"200px");realignDebugConsole()},onClick:function(e){var o=e.target,s;if(o==="cmdOpenLocomotives")locomotivesDlg.show(),w2ui.sidebar.unselect("cmdOpenLocomotives");else if(o==="cmdOpenBlocksAndFeedbacks")window.blocksDlg.show(),w2ui.sidebar.unselect("cmdOpenBlocksAndFeedbacks");else if(o==="cmdOpenRoutes")routesDlg.show(),w2ui.sidebar.unselect("cmdOpenRoutes");else if(o==="cmdAccessories")accessoriesDlg.show(),w2ui.sidebar.unselect("cmdAccessories");else if(o==="cmdOpenS88")window.dialogS88.show(),w2ui.sidebar.unselect("cmdOpenS88");else if(o==="cmdEditPlan")s=function(n){toggleAllLocomotiveInformation(n)},window.editState?(window.editState=!1,window.planField.setEditMode(!1),s(!0),window.toolbox.hideToolbox()):(window.editState=!0,window.planField.setEditMode(!0),s(!1),window.toolbox.showToolbox()),w2ui.sidebar.unselect("cmdEditPlan");else if(o==="cmdToggleLabels")n(e.node,"Labels","cmdToggleLabels",function(n){toggleAllLabelInformation(n);window.labelShown=n}),w2ui.sidebar.unselect("cmdToggleLabels");else if(o==="cmdToggleWebcams")n(e.node,"Webcams","cmdToggleWebcams",function(n){toggleAllWebcamsVisibility(n)}),w2ui.sidebar.unselect("cmdToggleWebcams");else if(o==="cmdLight")window.dialogLightAndPower.show(),w2ui.sidebar.unselect("cmdLight");else if(o==="cmdWorldClock")f(),w2ui.sidebar.unselect("cmdWorldClock");else if(o==="cmdPower")changeSetting({mode:"ecos",cmd:"power"}),w2ui.sidebar.unselect("cmdPower");else if(o==="cmdStop")changeSetting({mode:"ecos",cmd:"stop"}),w2ui.sidebar.unselect("cmdStop");else if(o==="cmdAutomatic"){const i=e.node.text,r=i.includes("off");t(r,!0,function(t){n(e.node,"Automatic","cmdAutomatic",null,t)});w2ui.sidebar.unselect("cmdAutomatic")}else o==="cmdInitialize"?(i(e.node),w2ui.sidebar.unselect("cmdInitialize")):o==="cmdAnalyzeRoutes"?(r(e.node),w2ui.sidebar.unselect("cmdAnalyzeRoutes")):o==="cmdShutdown"?(u(e.node),w2ui.sidebar.unselect("cmdShutdown")):o==="cmdChangeWorkspace"?(handleWorkspace(e.node),w2ui.sidebar.unselect("cmdChangeWorkspace")):o==="cmdHelp"?(window.open(constGitWebsite,"_blank"),w2ui.sidebar.unselect("cmdHelp")):o==="cmdAbout"&&(w2popup.open({title:"About",body:'<div class="w2ui-centered"><div style="font-weight: bold;">&copy; Dr. Christian Benjamin Ries<\/div><br><table style="text-align: center; margin: auto;"><tr><td>Contact:<\/td><td style="text-align: left;">rail@christianbenjaminries.de<\/td><\/tr><tr><td>License:<\/td><td style="text-align: left;">MIT<\/td><\/tr><tr><td>Sourcecode:<\/td><td style="text-align: left;"><a href="'+constGitWebsite+'" target="_blank">'+constGitWebsite+'<\/a><\/td><\/tr><tr><td>Website:<\/td><td style="text-align: left;"><a href="http://www.railessentials.net" target="_blank">www.railessentials.net<\/a><\/td><\/tr><tr><td>Used libraries:<\/td><td style="text-align: left;">TODO<\/td><\/tr><\/table><\/div>'}),w2ui.sidebar.unselect("cmdAbout"))}})};